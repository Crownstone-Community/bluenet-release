<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>Bluenet: Installation</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Bluenet
   &#160;<span id="projectnumber">0.3.0</span>
   </div>
   <div id="projectbrief">Bluenet, the firmware for the Crownstone power outlet</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Installation </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The installation has been tested on Ubuntu 14.04 and assumes you use the J-Link programmer.</p>
<h2>Prerequisites</h2>
<p>The installation should not be hard when you have the Nordic SDK. Get this from their website after buying a development kit. You also need a cross-compiler for ARM. You need the JLink utilities from Segger. And you need cmake for the build process.</p>
<h3>Nordic SDK</h3>
<p>Download Nordic's SDK and unzip:</p>
<ul>
<li><a href="https://developer.nordicsemi.com/nRF5_SDK/nRF51_SDK_v8.x.x/">Nordic nRF51822 SDK 8.1</a></li>
<li><a href="http://www.nordicsemi.com/eng/nordic/Products/nRF51822/S110-SD-v8/45846">Nordic S110 Softdevice 8.0</a> or <a href="https://www.nordicsemi.com/eng/nordic/Products/nRF51822/S130-SD/46579">Nordic S1130 Softdevice 1.0</a></li>
</ul>
<p>There is a bug in Nordics SDK code, search for files named <code>nrf_svc.h</code>. In those files, replace the assembly line: </p>
<pre class="fragment">"bx r14" : : "I" (number) : "r0" \
</pre><p>With: </p>
<pre class="fragment">"bx r14" : : "I" ((uint16_t)number) : "r0" \
</pre><h3>J-Link</h3>
<p>Download and install J-Link Seggerâ€™s <a href="http://www.segger.com/jlink-software.html">software</a>. We use 4.96.2 the <a href="https://www.segger.com/jlink-software.html?step=1&amp;file=JLinkLinuxDEB64_4.96.2">64bit .deb file version 4.96.2</a></p>
<p>Then install it: </p>
<pre class="fragment">sudo dpkg -i jlink_4.96.2_x86_64.deb
</pre><h3>Cross compiler</h3>
<p>A cross-compiler for ARM is the GCC cross-compiler which is maintained by the ARM folks on <a href="https://launchpad.net/gcc-arm-embedded">Launchpad</a>.</p>
<p>Download and extract version <a href="https://launchpad.net/gcc-arm-embedded/4.8/4.8-2014-q3-update/+download/gcc-arm-none-eabi-4_8-2014q3-20140805-linux.tar.bz2">2014-q3</a>.</p>
<p>Assuming you have a 64bit system, you will have to install some 32bit packages: </p>
<pre class="fragment">sudo dpkg --add-architecture i386
sudo apt-get update
sudo apt-get install libstdc++6:i386 libncurses5:i386
</pre><p>If the cross-compiler does not work, make sure you check if all its dependencies are met: </p>
<pre class="fragment">ldd /opt/gcc-arm-none-eabi-4_8-2014q3/bin/arm-none-eabi-gcc
</pre><h3>Misc.</h3>
<p>Bluenet uses a cmake build system, so you will need it: sudo apt-get install cmake</p>
<h2>Getting the Bluenet code</h2>
<p>The best way is to first <a href="https://github.com/dobots/bluenet/fork">fork</a> the bluenet repository. Then download the code: </p>
<pre class="fragment">git clone https://github.com/YOUR_GITHUB_USERNAME/bluenet
</pre><p>Set the correct upsteam and set environment variables: </p>
<pre class="fragment">cd bluenet
git remote add upstream git@github.com:dobots/bluenet.git
echo "export BLUENET_DIR=$PWD" &gt;&gt; ~/.bashrc
</pre><p>Make a new dir for your config file(s), for example <code>~/bluenet-config</code> </p>
<pre class="fragment">mkdir ~/bluenet-config
echo "export BLUENET_CONFIG_DIR=~/bluenet-config" &gt;&gt; ~/.bashrc
</pre><p>Apply the environment variables: </p>
<pre class="fragment">source ~/.bashrc
</pre><h2>Configuration</h2>
<p>Start writing your personal config file: </p>
<pre class="fragment">gedit $BLUENET_CONFIG_DIR/CMakeBuild.config &amp;
</pre><p>Copy the lines that you want to adjust from the default configuration: <code>$BLUENET_DIR/CMakeBuild.config.default</code>.</p>
<p>Installation dependent configurations:</p>
<ul>
<li>Set <code>COMPILER_PATH</code> to the path where the compiler can be found (it should contain the <code>/bin</code> subdir).</li>
<li>Set <code>COMPILER_TYPE</code> to the correct compiler type</li>
<li>Set <code>JLINK</code> to the correct JLink Exe file.</li>
<li>Set <code>JLINK_GDB_SERVER</code> to the correct file.</li>
<li>Set <code>NRF51822_DIR</code> to wherever you installed the Nordic SDK (it should contain the <code>/Include</code> and <code>/Source</code> subdirs).</li>
</ul>
<p>Softdevice dependent configurations:</p>
<ul>
<li>Set <code>SOFTDEVICE_DIR</code> to wherever you unzipped the SoftDevice dir from Nordic (it should contain the .hex file).</li>
<li>Set <code>SOFTDEVICE_DIR_API</code> to the directory with the SoftDevice include dir. This is relative, <code>${SOFTDEVICE_DIR}/${SOFTDEVICE_DIR_API}/</code> will be the used path.</li>
<li>Set <code>SOFTDEVICE accordingly</code> (basename of file without <code>_softdevice.hex</code>)</li>
<li>Set <code>SOFTDEVICE_SERIES</code>, <code>SOFTDEVICE_MAJOR</code>, and <code>SOFTDEVICE_MINOR</code> accordingly.</li>
</ul>
<p>Device dependent configuration:</p>
<ul>
<li>Set <code>BLUETOOTH_NAME</code> to something you like, but make sure it's short (&lt;10).</li>
<li>Set <code>INDOOR_SERVICE</code> to <code>1</code> if you want to enable it, the same is true for the other services. The indoor service only works for the s130.</li>
<li>Set <code>CHAR_SAMPLE_CURRENT</code> to <code>1</code> if you want to enable the sample current characteristics, the same is true for other characteristics.</li>
<li>Set <code>CHAR_MESHING</code> to <code>1</code> if you want to enable meshing functionality. This is relatively memory intensive, so you will need a 32kB version to run it.</li>
<li>You can adjust <code>SERIAL_VERBOSITY</code> if you want to see more or less output over the UART</li>
<li>Set <code>HARDWARE_BOARD</code> to the correct number for your board. This determines the pin layout.</li>
<li>Set <code>HARDWARE_VERSION</code> to the correct version of the NRF51 chip you have. Use <code>$BLUENET_DIR/scripts/hardware_version.sh</code> to check your version.</li>
<li>Set <code>IBEACON</code> to <code>1</code>, if you want to advertise like an iBeacon. You will want to set the correct values for the <code>BEACON_*</code> configs as well.</li>
<li>You can adjust the <code>MASTER_BUFFER_SIZE</code> when needed, this buffer is used on several different places.</li>
<li>If you run into memory issues, you can play around with <code>HEAP_SIZE</code>. Increasing the heap size (dynamic memory), will reduce the stack size (static memory).</li>
</ul>
<h2>Usage</h2>
<p>Once everything is installed and configured, the code can be compiled and uploaded. You will have to attach a programmer/debugger, like the JLink. Towards that you only need four pins: <code>GND</code>, <code>3V</code>, <code>SWDIO / RESET</code>, and <code>SWCLK / FACTORY</code>. The pin layout of the JLink connector is written out on the <a href="http://dobots.nl/2014/03/05/rfduino-without-rfduino-code/">DoBots blog</a>.</p>
<h3>Compiling, uploading and debugging</h3>
<p>First build and upload the SoftDevice: </p>
<pre class="fragment">cd $BLUENET_DIR/scripts
./softdevice.sh build
./softdevice.sh upload
</pre><p>Now we can build our own software: </p>
<pre class="fragment">cd $BLUENET_DIR/scripts
./firmware.sh build
</pre><p>If this fails due to misconfiguration, you might have to remove the <code>$BLUENET_DIR/build</code> dir.</p>
<p>To upload the application with the JLink you can use: </p>
<pre class="fragment">./firmware.sh upload
</pre><p>To debug with <code>gdb</code> you can use: </p>
<pre class="fragment">./firmware.sh debug
</pre><p>There is a shortcut to build and upload you can use: </p>
<pre class="fragment">./firmware.sh run
</pre><p>And another shortcut to build, upload, and debug: </p>
<pre class="fragment">./firmware.sh all
</pre><h2>Flashing with the ST-Link</h2>
<p>The above assumes you have the J-Link programmer from Nordic. If you do not have that device, you can still program something like the RFduino or the <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a>, by using an ST-Link. A full explanation can be found on <a href="https://dobots.nl/2015/01/23/programming-the-nrf51822-with-the-st-link/">https://dobots.nl/2015/01/23/programming-the-nrf51822-with-the-st-link/</a>.</p>
<p>Disclaimer: no work has been done on the ST-Link scripts for quite some time, so things might not work anymore.</p>
<h3>Combine softdevice and firmware</h3>
<p>First of all you should combine all the required binaries into one big binary. This is done by the script combine.sh. Before you use it, you will need to install srec_cat on your system. </p>
<pre class="fragment">sudo apt-get install srecord
</pre><p>If you call the script it basically just runs srec_cat: </p>
<pre class="fragment">./combine.sh
</pre><p>And you will see that it runs something like this: </p>
<pre class="fragment">srec_cat /opt/softdevices/s110_nrf51822_7.0.0_softdevice.hex -intel crownstone.bin -binary -offset 0x00016000 -o combined.hex -intel
</pre><p>You have to adjust that file on the moment manually to switch between softdevices or to add/remove the bootloader, sorry! Note that the result is a <code>.hex</code> file. Such a file does haveinformation across multiple memory sections. If you upload a <code>.bin</code> file often configuration bits/bytes will not be set!</p>
<h3>Upload with OpenOCD</h3>
<p>Rather than downloading <code>openocd</code> from the Ubuntu repositories, it is recommended to get the newest software from the source: </p>
<pre class="fragment">cd /opt
git clone https://github.com/ntfreak/openocd
sudo aptitude install libtool automake libusb-1.0-0-dev expect
cd openocd
./bootstrap
./configure --enable-stlink
make
sudo make install
</pre><p>Also, make sure you can use the USB ST-Link device without sudo rights: </p>
<pre class="fragment">sudo cp scripts/openocd/49-stlinkv2.rules /etc/udev/rules.d
sudo restart udev
</pre><p>You can now use the <code>flash_openocd.sh</code> script in the <code>scripts</code> directory: </p>
<pre class="fragment">./flash_openocd.sh init
</pre><p>And in another console: </p>
<pre class="fragment">./flash_openocd.sh upload combined.bin
</pre><p>Here the binary <code>combined.bin</code> is the softdevice and application combined.</p>
<h2>UART</h2>
<p>Currently UART is used for debugging. The TX pin is defined by the board type you configured (<code>HARDWARE_BOARD</code>), for each board type the TX pin nr can be found in the <code><a class="el" href="cs__Boards_8h_source.html">cs_Boards.h</a></code> file.</p>
<p>In case you happen to have the nRFgo Motherboard (nRF6310, strongly recommended) you can easily connect the pins at P2.0 and P2.1 to respectively the pins RXD and TXD on P15 on the board. Do not forget to switch on the RS232 switch. Subsequently you will need some RS232 to USB cable if you haven't an extremely old laptop.</p>
<p>The current set baudrate you can find in <code>cs_Serial.cpp</code> and is <code>38400</code> baud. To read from serial you can for example use <code>minicom</code> (replace ttyUSB0 with the correct device): </p>
<pre class="fragment">minicom -b 38400 -c on -D /dev/ttyUSB0
</pre><p>If this requires sudo rights, you may want to add yourself to the dialout group: </p>
<pre class="fragment">sudo adduser $USER dialout
</pre><p>You will have to logout and login for it to have effect.</p>
<p>If all goes well, you should see text appearing whenever the crownstone is rebooted/reset. This also shows you which services and characteristics are enabled. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
