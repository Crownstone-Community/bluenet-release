<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>Bluenet: # Bluenet protocol v0.10.0</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Bluenet
   &#160;<span id="projectnumber">0.3.0</span>
   </div>
   <div id="projectbrief">Bluenet, the firmware for the Crownstone power outlet</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title"># Bluenet protocol v0.10.0 </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="encryption"></a>Encryption</h1>
<p>By default, Crownstones have encryption enabled as a security and privacy measure.</p>
<h3>Setup mode</h3>
<p>When a <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a> is new or factory reset, it will go into setup mode.</p>
<p>Setup mode turns down the power of the antenna (low TX) so you can only communicate with it when you're close by. The purpose of this mode is to configure the <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a> so only you, or people in your group, can communicate with it.</p>
<p>The protocol here is as follows:</p>
<ol type="1">
<li><a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a> is in setup mode (low TX, <a href="#setup_service">Setup Service active</a>)</li>
</ol>
<ul>
<li>Phone is close and connects to the <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a></li>
<li>Phone reads the <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a> <a href="#setup_service">MAC address</a> (required for iOS). This characteristic is not encrypted.</li>
<li>Phone reads the session key and session nonce from the <a href="#setup_service">setup service</a>. These characteristics are not encrypted. The values are only valid for this connection session. The session key and the session nonce will be used to encrypt the rest of the setup phase using AES 128 CTR as explained <a href="#encrypted_write_read">here</a>.</li>
<li>Phone starts setting up the <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a> using the <a href="#setup_service">config control</a> characteristic<ul>
<li>Phone gives <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a> <a href="#crownstone_identifier">its identifier</a></li>
<li>Phone gives <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a> <a href="#admin_key">the Admin key</a></li>
<li>Phone gives <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a> <a href="#user_key">the User key</a></li>
<li>Phone gives <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a> <a href="#guest_key">the Guest key</a></li>
<li>Phone gives <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a> <a href="#mesh_access_address">the Mesh Access Address</a></li>
<li>Phone gives <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a> <a href="#ibeacon_uuid">its iBeacon UUID</a></li>
<li>Phone gives <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a> <a href="#ibeacon_major">its iBeacon Major</a></li>
<li>Phone gives <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a> <a href="#ibeacon_minor">its iBeacon Minor</a></li>
</ul>
</li>
<li>Phone commands <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a> <a href="#validate_setup">to leave setup mode</a></li>
</ul>
<h3>Using encryption after setup (normal mode)</h3>
<p>When encryption is enabled the following changes:</p>
<ul>
<li>The <a href="#scan_response_servicedata_packet">scan response packet service data</a> will be encrypted using the Guest key.</li>
<li>Values that are <b>read from</b> the characteristics will be encrypted</li>
<li>Values that are <b>written to</b> the characteristics will have to be encrypted</li>
</ul>
<h4><a class="anchor" id="session_nonce"></a>Session nonce</h4>
<p>After connecting, you first have to read the session nonce from the <a href="#crownstone_service">Crownstone service</a>. The session nonce is <a href="https://en.wikipedia.org/wiki/Block_cipher_mode_of_operation#Electronic_Codebook_.28ECB.29">ECB encrypted</a> with the guest key. After decryption, you should verify whether you have read and decrypted succesfully by checking if the validation key in the <a href="#encrypted_session_nonce">data</a> is equal to <b>0xCAFEBABE</b>. If so, you now have the correct session nonce.</p>
<p>The session nonce has two purposes:</p>
<ul>
<li>Validation: the first 4 bytes of the session nonce is what we call the validation key, it is used for any <a href="#encrypted_packet">encrypted packet</a>.</li>
<li>Encryption: the whole 5 bytes are used for the nonce, which is used for CTR encryption. The first 3 bytes of the nonce are the packet nonce (which should be randomly generated each time you write to a characteristic), the last 5 are the session nonce. The session nonce and validation key are only valid during the connection.</li>
</ul>
<h5><a class="anchor" id="encrypted_session_nonce"></a>Session nonce after ECB decryption</h5>
<table class="doxtable">
<tr>
<th>Type </th><th>Name </th><th>Length </th><th>Description  </th></tr>
<tr>
<td>uint 32 </td><td>Validation key </td><td>4 </td><td>0xCAFEBABE as validation. </td></tr>
<tr>
<td>byte array </td><td>Session nonce </td><td>5 </td><td>The session nonce for this session. </td></tr>
<tr>
<td>byte array </td><td>Padding </td><td>7 </td><td>Zero-padding so that the whole packet is 16 bytes. </td></tr>
</table>
<h3><a class="anchor" id="encrypted_write_read"></a>Reading and writing characteristics</h3>
<p>We use the <a href="https://en.wikipedia.org/wiki/Block_cipher_mode_of_operation#Counter_.28CTR.29">AES 128 CTR</a> method to encrypt everything that is written to- and read from characteristics. For this you need an 8 byte number called a <b>nonce</b>. The first 3 bytes of the nonce are sent with each packet, we call this the packet nonce. When writing to a characteristic, you should generate a new random packet nonce each time. The last 5 bytes of the nonce are called the session nonce, which should be read after connecting. When reading a characteristic, you should check if the (decrypted) validation key is equal to the validation key that was read <a href="#session_nonce">after connecting</a>.</p>
<h5><a class="anchor" id="encrypted_packet"></a>Encrypted Packet</h5>
<div class="image">
<img src="../docs/diagrams/encrypted-packet.png"  alt="Encrypted packet"/>
</div>
<table class="doxtable">
<tr>
<th>Type </th><th>Name </th><th>Length </th><th>Description  </th></tr>
<tr>
<td>byte array </td><td>Packet nonce </td><td>3 </td><td>First 3 bytes of nonce used in the encryption of this message. </td></tr>
<tr>
<td>uint 8 </td><td>User level </td><td>1 </td><td>0: Admin, 1: User, 2: Guest </td></tr>
<tr>
<td><a href="#encrypted_payload">Encrypted Payload</a> </td><td>Encrypted Payload </td><td>N*16 </td><td>The encrypted payload of N blocks. </td></tr>
</table>
<h5><a class="anchor" id="encrypted_payload"></a>Encrypted payload</h5>
<div class="image">
<img src="../docs/diagrams/encrypted-payload.png"  alt="Encrypted payload"/>
</div>
<table class="doxtable">
<tr>
<th>Type </th><th>Name </th><th>Length </th><th>Description  </th></tr>
<tr>
<td>uint 32 </td><td>Validation key </td><td>4 </td><td>Used to verify that the correct key was used for decryption/encryption. </td></tr>
<tr>
<td>byte array </td><td>Payload </td><td></td><td>Whatever data would have been sent if encryption was disabled. </td></tr>
<tr>
<td>byte array </td><td>Padding </td><td></td><td>Zero-padding so that the whole packet is of size N*16 bytes. </td></tr>
</table>
<h1>Advertisements and scan response</h1>
<p>When no device is connected, <a href="#ibeacon_packet">advertisements</a> will be sent at a regular interval (100ms by default). A device that actively scans, will also receive a <a href="#scan_response_packet">scan response packet</a>. This contains useful info about the state.</p>
<h3><a class="anchor" id="ibeacon_packet"></a>iBeacon advertisement packet</h3>
<p>This packet is according to iBeacon spec, see for example <a href="http://www.havlena.net/en/location-technologies/ibeacons-how-do-they-technically-work/">here</a>.</p>
<div class="image">
<img src="../docs/diagrams/adv-packet.png"  alt="Advertisement packet"/>
</div>
<table class="doxtable">
<tr>
<th>Type </th><th>Name </th><th>Length </th><th>Description  </th></tr>
<tr>
<td>uint 8 </td><td>AD Length </td><td>1 </td><td>Length of the Flags AD Structure (0x02) </td></tr>
<tr>
<td>uint 8 </td><td>AD Type </td><td>1 </td><td>Flags (0x01) </td></tr>
</table>
<p>uint 8 | Flags | 1 | uint 8 | AD Length | 1 | Length of the Manufacturer AD Structure (0x1A) uint 8 | AD Type | 1 | Manufacturer Specific Data (0xFF) uint 8 | Company Id | 2 | Apple (0x004C) uint 8 | iBeacon Type | 1 | <a class="el" href="classIBeacon.html" title="Implementation of the iBeacon specification. ">IBeacon</a> Type (0x02) uint 8 | iBeacon Length | 1 | <a class="el" href="classIBeacon.html" title="Implementation of the iBeacon specification. ">IBeacon</a> Length (0x15) uint 8 | Proximity <a class="el" href="classUUID.html" title="A Universally Unique IDentifier for BLE services and characteristics. ">UUID</a> | 16 | uint 16 | Major | 2 | uint 16 | Minor | 2 | int 8 | TX Power | 1 | Received signal strength at 1 meter.</p>
<h3><a class="anchor" id="scan_response_packet"></a>Scan response packet</h3>
<p>The packet that is sent when a BLE central scans.</p>
<div class="image">
<img src="../docs/diagrams/scan-response-packet.png"  alt="Scan Response packet"/>
</div>
<table class="doxtable">
<tr>
<th>Type </th><th>Name </th><th>Length </th><th>Description  </th></tr>
<tr>
<td>uint 8 </td><td>AD Length </td><td>1 </td><td>Length of the Name AD Structure (0x0A) </td></tr>
<tr>
<td>uint 8 </td><td>AD Type </td><td>1 </td><td>Shortened Local Name (0x08) </td></tr>
<tr>
<td>char [] </td><td>Name Bytes </td><td>8 </td><td>The shortened name of this device. </td></tr>
<tr>
<td>uint 8 </td><td>AD Length </td><td>1 </td><td>Length of the <a class="el" href="classService.html" title="Service as defined in the GATT Specification. ">Service</a> Data AD Structure (0x13) </td></tr>
<tr>
<td>uint 8 </td><td>AD Type </td><td>1 </td><td><a class="el" href="classService.html" title="Service as defined in the GATT Specification. ">Service</a> Data (0x16) </td></tr>
<tr>
<td>uint 16 </td><td><a class="el" href="classService.html" title="Service as defined in the GATT Specification. ">Service</a> <a class="el" href="classUUID.html" title="A Universally Unique IDentifier for BLE services and characteristics. ">UUID</a> </td><td>2 </td><td><a class="el" href="classService.html" title="Service as defined in the GATT Specification. ">Service</a> <a class="el" href="classUUID.html" title="A Universally Unique IDentifier for BLE services and characteristics. ">UUID</a> </td></tr>
<tr>
<td><a href="#scan_response_servicedata_packet">Service data</a> </td><td><a class="el" href="classService.html" title="Service as defined in the GATT Specification. ">Service</a> Data </td><td>17 </td><td><a class="el" href="classService.html" title="Service as defined in the GATT Specification. ">Service</a> data, state info. </td></tr>
</table>
<h3><a class="anchor" id="scan_response_servicedata_packet"></a>Scan response service data packet</h3>
<p>This packet contains the state info. If encryption is enabled, the last 16 bytes will be encrypted using <a href="https://en.wikipedia.org/wiki/Block_cipher_mode_of_operation#Electronic_Codebook_.28ECB.29">AES 128 ECB</a> using the guest key. You receive a MAC address on Android and an <a class="el" href="classUUID.html" title="A Universally Unique IDentifier for BLE services and characteristics. ">UUID</a> on iOS for each advertisement packet. This allows you to get the <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a> ID associated with the packet and you verify the decryption by checking the expected <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a> ID against the one in the packet.</p>
<div class="image">
<img src="../docs/diagrams/scan-response-service-data.png"  alt="Scan Response ServiceData"/>
</div>
<table class="doxtable">
<tr>
<th>Type </th><th>Name </th><th>Length </th><th>Description  </th></tr>
<tr>
<td>uint 8 </td><td>Protocol Version </td><td>1 </td><td><a class="el" href="classService.html" title="Service as defined in the GATT Specification. ">Service</a> data protocol version </td></tr>
<tr>
<td>uint 16 </td><td><a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a> ID </td><td>2 </td><td>ID that identifies this <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a>. </td></tr>
<tr>
<td>uint 8 </td><td><a href="#switch_state_packet">Switch state</a> </td><td>1 </td><td>The state of the switch. </td></tr>
<tr>
<td>uint 8 </td><td><a href="#event_bitmask">Event bitmask</a> </td><td>1 </td><td>Bitflags to indicate a certain state of the <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a>. </td></tr>
<tr>
<td>int 8 </td><td>Temperature </td><td>1 </td><td>Chip temperature (°C) </td></tr>
<tr>
<td>int 32 </td><td>Power usage </td><td>4 </td><td>The power usage at this moment (mW). </td></tr>
<tr>
<td>int 32 </td><td>Accumulated energy </td><td>4 </td><td>The accumulated energy (Wh). </td></tr>
<tr>
<td>uint 8[] </td><td>Rand </td><td>3 </td><td>Random bytes. </td></tr>
</table>
<h4><a class="anchor" id="event_bitmask"></a>Event Bitmask</h4>
<table class="doxtable">
<tr>
<th>Bit </th><th>Name </th><th>Description  </th></tr>
<tr>
<td>0 </td><td>New data available </td><td>If you request something from the <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a> and the result is available, this will be 1. </td></tr>
<tr>
<td>1 </td><td>Showing external data </td><td>If this is 1, the shown ID and data is from another <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a>. </td></tr>
<tr>
<td>2 </td><td>Error </td><td>If this is 1, the <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a> has an error, you should check what error it is. </td></tr>
<tr>
<td>3 </td><td>Reserved </td><td>Reserved for future use. </td></tr>
<tr>
<td>4 </td><td>Reserved </td><td>Reserved for future use. </td></tr>
<tr>
<td>5 </td><td>Reserved </td><td>Reserved for future use. </td></tr>
<tr>
<td>6 </td><td>Reserved </td><td>Reserved for future use. </td></tr>
<tr>
<td>7 </td><td>Setup mode active </td><td>If this is 1, the <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a> is in setup mode. </td></tr>
</table>
<h4><a class="anchor" id="switch_state_packet"></a><a class="el" href="classSwitch.html">Switch</a> <a class="el" href="classState.html" title="Load StateVars from and save StateVars to persistent storage. ">State</a> Packet</h4>
<p>To be able to distinguish between switching with relay and switching with <a class="el" href="classPWM.html" title="Pulse Wide Modulation class. ">PWM</a>, the switch state is a bit struct with the following layout</p>
<div class="image">
<img src="../docs/diagrams/switch_state_packet.png"  alt="Switch State Packet"/>
</div>
<p>Bit 7 is used for the relay flag, where 0 = OFF, 1 = ON. Bits 6-0 are used for <a class="el" href="classPWM.html" title="Pulse Wide Modulation class. ">PWM</a>, where 100 is fully ON, 0 is OFF, dimmed in between.</p>
<h1>Services</h1>
<p>When connected, the following services are available.</p>
<p>The AUG columns indicate which users can use these characteristics if encryption is enabled. The access can be further restricted per packet. Dots (..) indicate encryption is not enabled for that characteristic.</p>
<ul>
<li>A = Admin</li>
<li>U = User</li>
<li>G = Guest</li>
</ul>
<h2><a class="anchor" id="crownstone_service"></a><a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a> service</h2>
<p>The crownstone service has <a class="el" href="classUUID.html" title="A Universally Unique IDentifier for BLE services and characteristics. ">UUID</a> 24f00000-7d10-4805-bfc1-7663a01c3bff and provides all the functionality of the <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a> through the following services</p>
<table class="doxtable">
<tr>
<th><a class="el" href="classCharacteristic.html" title="A default characteristic. ">Characteristic</a> </th><th><a class="el" href="classUUID.html" title="A Universally Unique IDentifier for BLE services and characteristics. ">UUID</a> </th><th>Date type </th><th>Description </th><th align="center">A </th><th align="center">U </th><th align="center">G  </th></tr>
<tr>
<td>Control </td><td>24f00001-7d10-4805-bfc1-7663a01c3bff </td><td><a href="#control_packet">Control packet</a> </td><td>Write a command to the control characteristic </td><td align="center">x </td><td align="center">x </td><td align="center">x </td></tr>
</table>
<p><a class="anchor" id="mesh_control_characteristic"></a><a class="el" href="classMesh.html" title="Wrapper class around the mesh protocol files. ">Mesh</a> control | 24f00002-7d10-4805-bfc1-7663a01c3bff | <a href="#mesh_control_packet">Mesh control packet</a> | Write a command to the mesh control characteristic to send into the mesh | x | x | Config control | 24f00004-7d10-4805-bfc1-7663a01c3bff | <a href="#config_packet">Config packet</a> | Write or select a config setting | x | Config read | 24f00005-7d10-4805-bfc1-7663a01c3bff | <a href="#config_packet">Config packet</a> | Read or Notify on a previously selected config setting | x | <a class="el" href="classState.html" title="Load StateVars from and save StateVars to persistent storage. ">State</a> control | 24f00006-7d10-4805-bfc1-7663a01c3bff | <a href="#state_packet">State packet</a> | Select a state variable | x | x | <a class="el" href="classState.html" title="Load StateVars from and save StateVars to persistent storage. ">State</a> read | 24f00007-7d10-4805-bfc1-7663a01c3bff | <a href="#state_packet">State packet</a> | Read or Notify on a previously selected state variable | x | x | Session nonce | 24f00008-7d10-4805-bfc1-7663a01c3bff | uint 8 [5] | Read the <a href="#session_nonce">session nonce</a>. First 4 bytes are also used as session key. | | | ECB Recovery | 24f00009-7d10-4805-bfc1-7663a01c3bff | uint32 | Used for <a href="#recovery">recovery</a>. |</p>
<h5><a class="anchor" id="recovery"></a>Recovery</h5>
<p>If you lose your encryption keys you can use this characteristic to factory reset the <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a>. This method is only available for 20 seconds after the <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a> powers on. You need to write <b>0xDEADBEEF</b> to it. After this, the <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a> disconnects and goes into Low TX mode so you'll have to be close to continue the factory reset. After this, you reconnect and write <b>0xDEADBEEF</b> again to this characteristic to factory reset the <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a>.</p>
<h5><a class="anchor" id="return_values"></a>Return values</h5>
<p>The control characteristics (Control, <a class="el" href="classMesh.html" title="Wrapper class around the mesh protocol files. ">Mesh</a> Control, Config Control and <a class="el" href="classState.html" title="Load StateVars from and save StateVars to persistent storage. ">State</a> Control) of the <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a> service return a uint16 code on execution of the command. The code determines success or failure of the command. If commands have to be executed sequentially, make sure that the return value of the previous command was received before calling the next (either by polling or subscribing). The possible values of the return values are listed in the table below</p>
<table class="doxtable">
<tr>
<th>Value </th><th>Name </th><th>Description  </th></tr>
<tr>
<td>0 </td><td>SUCCESS </td><td>completed successfully </td></tr>
<tr>
<td>1 </td><td>VALUE_UNDEFINED </td><td>no value provided </td></tr>
<tr>
<td>2 </td><td>WRONG_PAYLOAD_LENGTH </td><td>wrong payload lenght provided </td></tr>
<tr>
<td>3 </td><td>UNKNOWN_OP_CODE </td><td>unknown operation code, e.g. notify for config read </td></tr>
<tr>
<td>5 </td><td>BUFFER_LOCKED </td><td>buffer is locked, failed queue command </td></tr>
<tr>
<td>6 </td><td>BUFFER_TOO_SMALL </td><td>buffer is too small to execute command </td></tr>
<tr>
<td>256 </td><td>COMMAND_NOT_FOUND </td><td>command type not found </td></tr>
<tr>
<td>257 </td><td>NOT_AVAILABLE </td><td>command not available in this mode </td></tr>
<tr>
<td>258 </td><td>WRONG_PARAMETER </td><td>wrong parameter provided </td></tr>
<tr>
<td>259 </td><td>COMMAND_FAILED </td><td>other failure </td></tr>
<tr>
<td>260 </td><td>NOT_IMPLEMENTED </td><td>command not implemented (only debug version) </td></tr>
<tr>
<td>512 </td><td>INVALID_MESSAGE </td><td>invalid mesh message provided </td></tr>
<tr>
<td>768 </td><td>READ_CONFIG_FAILED </td><td>read configuration failed </td></tr>
<tr>
<td>769 </td><td>WRITE_CONFIG_DISABLED </td><td>write configuration disalbed for this type </td></tr>
<tr>
<td>770 </td><td>CONFIG_NOT_FOUND </td><td>config type not found </td></tr>
<tr>
<td>1024 </td><td>STATE_NOT_FOUND </td><td>state type not found </td></tr>
<tr>
<td>1025 </td><td>STATE_WRITE_DISABLED </td><td>writing to state disabled </td></tr>
</table>
<h2><a class="anchor" id="setup_service"></a>Setup service</h2>
<p>The setup service has <a class="el" href="classUUID.html" title="A Universally Unique IDentifier for BLE services and characteristics. ">UUID</a> 24f10000-7d10-4805-bfc1-7663a01c3bff and is only available after a factory reset or when you first power on the <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a>. When encryption is enabled, the control and both config characteristics are encrypted with AES CTR. The key and session Nonce for this are gotten from their characteristics.</p>
<table class="doxtable">
<tr>
<th><a class="el" href="classCharacteristic.html" title="A default characteristic. ">Characteristic</a> </th><th><a class="el" href="classUUID.html" title="A Universally Unique IDentifier for BLE services and characteristics. ">UUID</a> </th><th>Date type </th><th>Description  </th></tr>
<tr>
<td>Control </td><td>24f10001-7d10-4805-bfc1-7663a01c3bff </td><td><a href="#control_packet">Control packet</a> </td><td>Write a command to the control characteristic </td></tr>
<tr>
<td>MAC address </td><td>24f10002-7d10-4805-bfc1-7663a01c3bff </td><td>uint 8 [6] </td><td>Read the MAC address of the device </td></tr>
<tr>
<td>Session key </td><td>24f10003-7d10-4805-bfc1-7663a01c3bff </td><td>uint 8 [16] </td><td>Read the session key that will be used to encrypt the control and config characteristics. </td></tr>
<tr>
<td>Config control </td><td>24f10004-7d10-4805-bfc1-7663a01c3bff </td><td><a href="#config_packet">Config packet</a> </td><td>Write or select a config setting </td></tr>
<tr>
<td>Config read </td><td>24f10005-7d10-4805-bfc1-7663a01c3bff </td><td><a href="#config_packet">Config packet</a> </td><td>Read or Notify on a previously selected config setting </td></tr>
<tr>
<td>GoTo DFU </td><td>24f10006-7d10-4805-bfc1-7663a01c3bff </td><td>uint 8 </td><td>Write 66 to go to DFU </td></tr>
<tr>
<td>Session nonce </td><td>24f10008-7d10-4805-bfc1-7663a01c3bff </td><td>uint 8 [5] </td><td>Read the session nonce. First 4 bytes are also used as validation key. </td></tr>
</table>
<p>The control characteristics (Control, and Config Control) of the Setup <a class="el" href="classService.html" title="Service as defined in the GATT Specification. ">Service</a> return a uint 16 code on execution of the command. The code determines success or failure of the command. If commands have to be executed sequentially, make sure that the return value of the previous command was received before calling the next (either by polling or subscribing). The possible values are the same as for the <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a> <a class="el" href="classService.html" title="Service as defined in the GATT Specification. ">Service</a>, see above.</p>
<h2>General service</h2>
<p>The general service has <a class="el" href="classUUID.html" title="A Universally Unique IDentifier for BLE services and characteristics. ">UUID</a> 24f20000-7d10-4805-bfc1-7663a01c3bff.</p>
<p><a class="el" href="classCharacteristic.html" title="A default characteristic. ">Characteristic</a> | <a class="el" href="classUUID.html" title="A Universally Unique IDentifier for BLE services and characteristics. ">UUID</a> | Date type | Description | A | U | G &mdash; | &mdash; | &mdash; | &mdash; | :&mdash;: | :&mdash;: | :&mdash;: Temperature | 24f20001-7d10-4805-bfc1-7663a01c3bff | int 32 | Chip temperature in Celcius. Notifications are available. | x Reset | 24f20002-7d10-4805-bfc1-7663a01c3bff | uint 8 | Write 1 to reset. Write 66 to go to DFU mode. | x</p>
<h2>Power service</h2>
<p>The power service has <a class="el" href="classUUID.html" title="A Universally Unique IDentifier for BLE services and characteristics. ">UUID</a> 24f30000-7d10-4805-bfc1-7663a01c3bff. <b>Should be encrypted but it is not at the moment due to implementation.</b></p>
<p><a class="el" href="classCharacteristic.html" title="A default characteristic. ">Characteristic</a> | <a class="el" href="classUUID.html" title="A Universally Unique IDentifier for BLE services and characteristics. ">UUID</a> | Date type | Description | A | U | G &mdash; | &mdash; | &mdash; | &mdash; | :&mdash;: | :&mdash;: | :&mdash;: <a class="el" href="classPWM.html" title="Pulse Wide Modulation class. ">PWM</a> | 24f30001-7d10-4805-bfc1-7663a01c3bff | uint 8 | Set <a class="el" href="classPWM.html" title="Pulse Wide Modulation class. ">PWM</a> value. Value of 0 is completely off, 255 (100 on new devices) is completely on. | x Relay | 24f30002-7d10-4805-bfc1-7663a01c3bff | uint 8 | <a class="el" href="classSwitch.html">Switch</a> Relay. Value of 0 is off, other is on. | x Power samples | 24f30003-7d10-4805-bfc1-7663a01c3bff | <a href="#power_samples_packet">Power Samples</a> | List of sampled current and voltage values. | ... Power consumption | 24f30004-7d10-4805-bfc1-7663a01c3bff | uint 16 | The current power consumption. | x</p>
<h2>Indoor localization service</h2>
<p>The localization service has <a class="el" href="classUUID.html" title="A Universally Unique IDentifier for BLE services and characteristics. ">UUID</a> 24f40000-7d10-4805-bfc1-7663a01c3bff.</p>
<p><a class="el" href="classCharacteristic.html" title="A default characteristic. ">Characteristic</a> | <a class="el" href="classUUID.html" title="A Universally Unique IDentifier for BLE services and characteristics. ">UUID</a> | Date type | Description | A | U | G &mdash; | &mdash; | &mdash; | &mdash; | :&mdash;: | :&mdash;: | :&mdash;: Track control | 24f40001-7d10-4805-bfc1-7663a01c3bff | <a href="#tracked_device_packet">Tracked device</a> | Add or overwrite a tracked device. Set threshold larger than 0 to remove the tracked device from the list. | x Tracked devices | 24f40002-7d10-4805-bfc1-7663a01c3bff | <a href="#tracked_device_list_packet">Tracked device list</a> | Read the current list of tracked devices. | x Scan control | 24f40003-7d10-4805-bfc1-7663a01c3bff | uint 8 | Start or stop scanning. write 0 to stop, 1 to start. | x Scanned devices | 24f40004-7d10-4805-bfc1-7663a01c3bff | <a href="#scan_result_list_packet">Scan result list</a> | After stopping the scan, you can read the results here. | x RSSI | 24f40005-7d10-4805-bfc1-7663a01c3bff | uint 8 | RSSI to connected device. Notifications are available. | x</p>
<h2>Schedule service</h2>
<p>The schedule service has <a class="el" href="classUUID.html" title="A Universally Unique IDentifier for BLE services and characteristics. ">UUID</a> 24f50000-7d10-4805-bfc1-7663a01c3bff.</p>
<p><a class="el" href="classCharacteristic.html" title="A default characteristic. ">Characteristic</a> | <a class="el" href="classUUID.html" title="A Universally Unique IDentifier for BLE services and characteristics. ">UUID</a> | Date type | Description | A | U | G &mdash; | &mdash; | &mdash; | &mdash; | :&mdash;: | :&mdash;: | :&mdash;: Set time | 24f50001-7d10-4805-bfc1-7663a01c3bff | uint 32 | Sets the time. Timestamp is in seconds since epoch. | x Schedule write | 24f50002-7d10-4805-bfc1-7663a01c3bff | <a href="#schedule_entry_packet">Schedule entry</a> | Add or modify a schedule entry. Set nextTimestamp to 0 to remove the entry from the list. | x Schedule read | 24f50003-7d10-4805-bfc1-7663a01c3bff | <a href="#schedule_list_packet">Schedule list</a> | Get a list of all schedule entries. | x</p>
<h2><a class="el" href="classMesh.html" title="Wrapper class around the mesh protocol files. ">Mesh</a> <a class="el" href="classService.html" title="Service as defined in the GATT Specification. ">Service</a></h2>
<p>The mesh service comes with <a href="https://github.com/NordicSemiconductor/nRF51-ble-bcast-mesh">OpenMesh</a> and has <a class="el" href="classUUID.html" title="A Universally Unique IDentifier for BLE services and characteristics. ">UUID</a> 0000fee4-0000-1000-8000-00805f9b34fb</p>
<p><a class="el" href="classCharacteristic.html" title="A default characteristic. ">Characteristic</a> | <a class="el" href="classUUID.html" title="A Universally Unique IDentifier for BLE services and characteristics. ">UUID</a> | Date type | Description | A | U | G &mdash; | &mdash; | &mdash; | &mdash; | :&mdash;: | :&mdash;: | :&mdash;: Meta data | 2a1e0004-fd51-d882-8ba8-b98c0000cd1e | | Get mesh configuration. | x Value | 2a1e0005-fd51-d882-8ba8-b98c0000cd1e | | <a class="el" href="classCharacteristic.html" title="A default characteristic. ">Characteristic</a> where the mesh values can be read. | x</p>
<h1>Data structures</h1>
<h3><a class="anchor" id="control_packet"></a>Control packet</h3>
<div class="image">
<img src="../docs/diagrams/control-packet.png"  alt="Control packet"/>
</div>
<h5>If encryption is enabled, this packet must be encrypted using any of the keys where the box is checked.</h5>
<p>In the case of the setup mode, only the Validate Setup command is available unencrypted.</p>
<table class="doxtable">
<tr>
<th>Type </th><th>Name </th><th>Length </th><th>Description  </th></tr>
<tr>
<td>uint 8 </td><td>Type </td><td>1 </td><td>Command type, see table below. </td></tr>
<tr>
<td>uint 8 </td><td>Reserved </td><td>1 </td><td>Not used: reserved for alignment. </td></tr>
<tr>
<td>uint 16 </td><td>Length </td><td>2 </td><td>Length of the payload in bytes. </td></tr>
<tr>
<td>uint 8 </td><td>Payload </td><td>Length </td><td>Payload data, depends on type. </td></tr>
</table>
<p>The AUG columns indicate which users have access to these commands if encryption is enabled. Admin access means the packet is encrypted with the admin key.</p>
<ul>
<li>A: Admin</li>
<li>U: User</li>
<li>G: Guest</li>
</ul>
<p>Available command types:</p>
<table class="doxtable">
<tr>
<th>Type nr </th><th>Type name </th><th>Payload type </th><th>Payload Description </th><th align="center">A </th><th align="center">U </th><th align="center">G  </th></tr>
<tr>
<td>0 </td><td><a class="el" href="classSwitch.html">Switch</a> </td><td>uint 8 </td><td><a class="el" href="classSwitch.html">Switch</a> power, 0 = OFF, 100 = FULL ON </td><td align="center">x </td><td align="center">x </td><td align="center">x </td></tr>
<tr>
<td>1 </td><td><a class="el" href="classPWM.html" title="Pulse Wide Modulation class. ">PWM</a> </td><td>uint 8 </td><td>Set <a class="el" href="classPWM.html" title="Pulse Wide Modulation class. ">PWM</a> to value, 0 = OFF, 100 = FULL ON </td><td align="center">x </td><td align="center">x </td><td align="center">x </td></tr>
</table>
<p>2 | Set Time | uint 32 | Set time to value, where value is seconds since 1970-01-01 00:00:00 UTC | x | x | 3 | Goto DFU | - | Reset device to DFU mode | x 4 | Reset | uint 8 | Reset device | x 5 | Factory reset | uint 32 | Reset device to factory setting, needs Code 0xdeadbeef as payload | x 6 | Keep alive state | <a href="#cmd_keep_alive_payload">Keep alive payload</a> | Keep alive with state | x | x | 7 | Keep alive | - | Keep alive without state, uses last state transmitted with Keep alive state command | x | x | x 8 | Enable mesh | uint 8 | Enable/Disable <a class="el" href="classMesh.html" title="Wrapper class around the mesh protocol files. ">Mesh</a>, 0 = OFF, other = ON | x 9 | Enable encryption | uint 8 | Enable/Disable Encryption, 0 = OFF, other = ON. Only has effect after a reset. | x 10 | Enable iBeacon | uint 8 | Enable/Disable iBeacon, 0 = OFF, other = ON | x 11 | Enable continuous power measurement | uint 8 | Enable/Disable continuous power measurement, 0 = OFF, other = ON. <b>Deprecated</b> | x 12 | Enable scanner | <a href="#cmd_enable_scanner_payload">Enable Scanner payload</a> | Enable/Disable scanner | x 13 | Scan for devices | uint 8 | Scan for devices, 0 = OFF, other = ON | x | 14 | User feedback | ... | User feedback ..., TBD | x | 15 | Schedule entry | <a href="#schedule_entry_packet">Schedule entry payload</a> | Add or remove a schedule entry | x | x 16 | Relay | uint 8 | <a class="el" href="classSwitch.html">Switch</a> relay, 0 = OFF, 1 = ON | x | x | x 17 | <a class="anchor" id="validate_setup"></a>Validate setup | - | Validate Setup, only available in setup mode, makes sure everything is configured, then reboots to normal mode | ..| .. | .. 18 | Request <a class="el" href="classService.html" title="Service as defined in the GATT Specification. ">Service</a> Data | - | Causes the crownstone to send it's service data over the mesh | x | x | 19 | Disconnect | - | Causes the crownstone to disconnect | .. | .. | .. 20 | Set LED | ?? | Enable or disabled LEDS | x 21 | No operation | - | Does nothing, merely there to keep the crownstone from disconnecting | x | x | x 22 | Increase TX | - | Temporarily increase the TX power when in setup mode | x | x | x 23 | Reset errors | <a href="#state_error_bitmask">Error bitmask</a> | Reset all errors which are set in the written bitmask. | x 24 | Keepalive mesh | - | Repeat the last keep alive message on the mesh. | x | x | x 25 | Multi switch | <a href="#multi_switch_mesh_packet">Multi switch packet</a> | <a class="el" href="classSwitch.html">Switch</a> multiple crownstones with a command over the mesh. | x | x | x</p>
<h4><a class="anchor" id="cmd_enable_scanner_payload"></a>Enable <a class="el" href="classScanner.html" title="Scanner scans for BLE devices. ">Scanner</a> payload</h4>
<table class="doxtable">
<tr>
<th>Type </th><th>Name </th><th>Description  </th></tr>
<tr>
<td>uint 8 </td><td>enable </td><td>0 = OFF, other = ON </td></tr>
<tr>
<td>uint 16 </td><td>delay </td><td>start scanner with delay in ms </td></tr>
</table>
<h4><a class="anchor" id="cmd_keep_alive_payload"></a>Keep alive payload</h4>
<table class="doxtable">
<tr>
<th>Type </th><th>Name </th><th>Description  </th></tr>
<tr>
<td>uint 8 </td><td>Action </td><td>Action, 0 = No Change, 1 = Change </td></tr>
<tr>
<td>uint 8 </td><td><a class="el" href="classSwitch.html">Switch</a> </td><td><a class="el" href="classSwitch.html">Switch</a> power, 0 = OFF, 100 = FULL ON </td></tr>
<tr>
<td>uint 16 </td><td>Timeout </td><td>Timeout in seconds after which the <a class="el" href="classSwitch.html">Switch</a> should be adjusted to the <a class="el" href="classSwitch.html">Switch</a> value </td></tr>
</table>
<h3><a class="anchor" id="config_packet"></a>Configuration packet</h3>
<div class="image">
<img src="../docs/diagrams/config-packet.png"  alt="Configuration packet"/>
</div>
<h5>If encryption is enabled, this packet must be encrypted using the admin key.</h5>
<table class="doxtable">
<tr>
<th>Type </th><th>Name </th><th>Length </th><th>Description  </th></tr>
<tr>
<td>uint 8 </td><td>Type </td><td>1 </td><td>Type, see table with configuration types below. </td></tr>
<tr>
<td>uint 8 </td><td>OpCode </td><td>1 </td><td>The op code determines if it's a write or a read operation, see table with op codes below </td></tr>
<tr>
<td>uint 16 </td><td>Length </td><td>2 </td><td>Length of the payload in bytes. </td></tr>
<tr>
<td>uint 8 </td><td>Payload </td><td>Length </td><td>Payload data, depends on type. </td></tr>
</table>
<p>Available configurations types:</p>
<table class="doxtable">
<tr>
<th>Type nr </th><th>Type name </th><th>Payload type </th><th>Description  </th></tr>
<tr>
<td>0 </td><td>Device name </td><td>char [] </td><td>Name of the device. </td></tr>
<tr>
<td>1 </td><td>Device type </td><td>char [] </td><td><b>Deprecated.</b> </td></tr>
<tr>
<td>2 </td><td>Room </td><td>uint 8 </td><td><b>Deprecated.</b> </td></tr>
<tr>
<td>3 </td><td>Floor </td><td>uint 8 </td><td>Floor number. <b>Deprecated</b> </td></tr>
<tr>
<td>4 </td><td>Nearby timeout </td><td>uint 16 </td><td>Time in ms before switching off when none is nearby </td></tr>
<tr>
<td>5 </td><td><a class="el" href="classPWM.html" title="Pulse Wide Modulation class. ">PWM</a> period </td><td>uint 32 </td><td>Sets <a class="el" href="classPWM.html" title="Pulse Wide Modulation class. ">PWM</a> period in μs. <b>Setting this to a wrong value may cause damage.</b> </td></tr>
<tr>
<td>6 </td><td><a class="anchor" id="ibeacon_major"></a>iBeacon major </td><td>uint 16 </td><td>iBeacon major number. </td></tr>
<tr>
<td>7 </td><td><a class="anchor" id="ibeacon_minor"></a>iBeacon minor </td><td>uint 16 </td><td>iBeacon minor number. </td></tr>
<tr>
<td>8 </td><td><a class="anchor" id="ibeacon_uuid"></a>iBeacon <a class="el" href="classUUID.html" title="A Universally Unique IDentifier for BLE services and characteristics. ">UUID</a> </td><td>uint 8 [16] </td><td>iBeacon <a class="el" href="classUUID.html" title="A Universally Unique IDentifier for BLE services and characteristics. ">UUID</a>. </td></tr>
<tr>
<td>9 </td><td>iBeacon Tx Power </td><td>int 8 </td><td>iBeacon signal strength at 1 meter. </td></tr>
<tr>
<td>11 </td><td>TX power </td><td>int 8 </td><td>TX power, can be: -40, -30, -20, -16, -12, -8, -4, 0, or 4. </td></tr>
<tr>
<td>12 </td><td>Advertisement interval </td><td>uint 16 </td><td>Advertisement interval between 0x0020 and 0x4000 in units of 0.625 ms. </td></tr>
<tr>
<td>13 </td><td>Passkey </td><td>uint 8 [6] </td><td>Passkey of the device: must be 6 digits. </td></tr>
<tr>
<td>14 </td><td>Min env temp </td><td>int 8 </td><td>If temperature (in degrees Celcius) goes below this value, send an alert (not implemented yet). </td></tr>
<tr>
<td>15 </td><td>Max env temp </td><td>int 8 </td><td>If temperature (in degrees Celcius) goes above this value, send an alert (not implemented yet). </td></tr>
<tr>
<td>16 </td><td>Scan duration </td><td>uint 16 </td><td>Scan duration in ms. <em>Setting this too high may cause the device to reset during scanning.</em> </td></tr>
<tr>
<td>17 </td><td>Scan send delay </td><td>uint 16 </td><td>Time in ms to wait before sending scan results over the mesh. <em>Setting this too low may cause the device to reset during scanning.</em> </td></tr>
<tr>
<td>18 </td><td>Scan break duration </td><td>uint 16 </td><td>Waiting time in ms between sending results and next scan. <em>Setting this too low may cause the device to reset during scanning.</em> </td></tr>
<tr>
<td>19 </td><td>Boot delay </td><td>uint 16 </td><td>Time to wait with radio after boot, <b>Setting this too low may cause the device to reset on boot.</b> </td></tr>
<tr>
<td>20 </td><td>Max chip temp </td><td>int 8 </td><td>If the chip temperature (in degrees Celcius) goes above this value, the power gets switched off. </td></tr>
<tr>
<td>21 </td><td>Scan filter </td><td>uint 8 </td><td>Filter out certain types of devices from the scan results (1 for GuideStones, 2 for CrownStones, 3 for both). </td></tr>
<tr>
<td>22 </td><td>Scan filter fraction </td><td>uint 16 </td><td>If scan filter is set, do <em>not</em> filter them out each every X scan results. </td></tr>
<tr>
<td>23 </td><td>Current limit </td><td>uint 8 </td><td>Set current limit to <b>Deprecated</b> </td></tr>
<tr>
<td>24 </td><td><a class="el" href="classMesh.html" title="Wrapper class around the mesh protocol files. ">Mesh</a> enabled </td><td>uint 8 </td><td>Stores if mesh is enabled. <em>read only</em> </td></tr>
<tr>
<td>25 </td><td>Encryption enabled </td><td>uint 8 </td><td>Stores if encryption is enabled. <em>read only</em> </td></tr>
<tr>
<td>26 </td><td>iBeacon enabled </td><td>uint 8 </td><td>Stores if iBeacon is enabled. <em>read only</em> </td></tr>
<tr>
<td>27 </td><td><a class="el" href="classScanner.html" title="Scanner scans for BLE devices. ">Scanner</a> enabled </td><td>uint 8 </td><td>Stores if device scanning is enabled. <em>read only</em> </td></tr>
<tr>
<td>28 </td><td>Continuous power measurement enabled </td><td>uint 8 </td><td>Stores if continuous power measurement is enabled. <em>read only</em> </td></tr>
<tr>
<td>29 </td><td><a class="el" href="classTracker.html">Tracker</a> enabled </td><td>uint 8 </td><td>Stores if device tracking is enabled. <em>read only</em> </td></tr>
<tr>
<td>30 </td><td><a class="el" href="classADC.html" title="Analog-Digital conversion. ">ADC</a> sample rate </td><td>... </td><td>TBD </td></tr>
<tr>
<td>31 </td><td>Power sample burst interval </td><td>... </td><td>TBD </td></tr>
<tr>
<td>32 </td><td>Power sample continuous interval </td><td>... </td><td>TBD </td></tr>
<tr>
<td>33 </td><td>Power sample continuous number samples </td><td>... </td><td>TBD </td></tr>
<tr>
<td>34 </td><td><a class="anchor" id="crownstone_identifier"></a><a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a> Identifier </td><td>uint 16 </td><td><a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a> identifier used in advertisement package </td></tr>
<tr>
<td>35 </td><td><a class="anchor" id="admin_key"></a>Admin encryption key </td><td>uint 8 [16] </td><td>16 byte key used to encrypt/decrypt owner access functions </td></tr>
<tr>
<td>36 </td><td><a class="anchor" id="user_key"></a>Member encryption key </td><td>uint 8 [16] </td><td>16 byte key used to encrypt/decrypt member access functions </td></tr>
<tr>
<td>37 </td><td><a class="anchor" id="guest_key"></a>Guest encryption key </td><td>uint 8 [16] </td><td>16 byte key used to encrypt/decrypt guest access functions </td></tr>
<tr>
<td>38 </td><td>Default ON </td><td>uint 8 </td><td>Set's the default switch state to 255 if true, or to 0 if false. Value is 0 for false, or any other for true </td></tr>
<tr>
<td>39 </td><td>Scan Interval </td><td>uint 16 </td><td>Set the scan interval to ... </td></tr>
<tr>
<td>40 </td><td>Scan Window </td><td>uint 16 </td><td>Set the scan window to ... </td></tr>
<tr>
<td>41 </td><td>Relay High Duration </td><td>uint 16 </td><td>Set the time/duration that the relay is set to high (ms) </td></tr>
<tr>
<td>42 </td><td>Low Tx Power </td><td>int 8 </td><td>Set the tx power used when in low transmission power for bonding </td></tr>
<tr>
<td>43 </td><td>Voltage Multiplier </td><td>float </td><td>Set the voltage multiplier (for power measurement) </td></tr>
<tr>
<td>44 </td><td>Current Multiplier </td><td>float </td><td>Set the current multiplier (for power measurement) </td></tr>
<tr>
<td>45 </td><td>Voltage Zero </td><td>int 32 </td><td>Set the voltage zero level (for power measurement) </td></tr>
<tr>
<td>46 </td><td>Current Zero </td><td>int 32 </td><td>Set the current zero level (for power measurement) </td></tr>
<tr>
<td>47 </td><td>Power Zero </td><td>int 32 </td><td>Set the power zero level in mW (for power measurement) </td></tr>
<tr>
<td>48 </td><td>Power Average Window </td><td>uint16 </td><td>Deprecated </td></tr>
<tr>
<td>49 </td><td><a class="anchor" id="mesh_access_address"></a><a class="el" href="classMesh.html" title="Wrapper class around the mesh protocol files. ">Mesh</a> Access Address </td><td>uint32 </td><td>The access address of the mesh messages. This ensures that mesh messages of other groups will not interfere with your group. </td></tr>
</table>
<p>OpCodes:</p>
<table class="doxtable">
<tr>
<th>OpCode </th><th>Name </th><th>Description  </th></tr>
<tr>
<td>0 </td><td>Read </td><td>Select the configuration setting for reading. will load it from storage, then write it to the Config Read <a class="el" href="classCharacteristic.html" title="A default characteristic. ">Characteristic</a>. Length and payload of the configuration packet will be ignored </td></tr>
<tr>
<td>1 </td><td>Write </td><td>Write the configuration setting to storage. </td></tr>
</table>
<p>Note: On the Config Read <a class="el" href="classCharacteristic.html" title="A default characteristic. ">Characteristic</a>, the OpCode is set to Read (0), and the length and payload will have actual data depending on the type.</p>
<h3><a class="anchor" id="state_packet"></a><a class="el" href="classState.html" title="Load StateVars from and save StateVars to persistent storage. ">State</a> packet</h3>
<div class="image">
<img src="../docs/diagrams/state-packet.png"  alt="State packet"/>
</div>
<table class="doxtable">
<tr>
<th>Type </th><th>Name </th><th>Length </th><th>Description  </th></tr>
<tr>
<td>uint 8 </td><td>Type </td><td>1 </td><td>Type, see table with configuration types below. </td></tr>
<tr>
<td>uint 8 </td><td>OpCode </td><td>1 </td><td>The op code determines if it's a write, read, or notify operation, see table with op codes below </td></tr>
<tr>
<td>uint 16 </td><td>Length </td><td>2 </td><td>Length of the payload in bytes. </td></tr>
<tr>
<td>uint 8 </td><td>Payload </td><td>Length </td><td>Payload data, depends on type. </td></tr>
</table>
<p>Available state variables:</p>
<table class="doxtable">
<tr>
<th>Type nr </th><th>Type name </th><th>Payload type </th><th>Description </th><th align="center">Persistent  </th></tr>
<tr>
<td>128 </td><td>Reset counter </td><td>uint 32 </td><td>Counts the number of resets (DEBUG). </td><td align="center">x </td></tr>
</table>
<p>129 | <a href="#switch_state_packet">Switch state</a> | uint 8 | Current <a class="el" href="classSwitch.html">Switch</a> state. | 130 | Accumulated energy | uint 32 | Accumulated energy in Wh | x 131 | Power usage | uint 32 | Current power usage in mW | 132 | Tracked devices | <a href="#tracked_device_list_packet">Tracked devices</a> | List of tracked devices. | x 133 | Schedule | <a href="#schedule_list_packet">Schedule List</a> | Schedule list. | x 134 | Operation Mode | uint 8 | ..., TBD | x 135 | Temperature | int 32 | Chip temperature in °C. | 136 | Time | uint 32 | Get the current time. 139 | <a href="#state_error_bitmask">Error bitmask</a> | uint 32 | Get the current error bitmask.</p>
<p>OpCodes:</p>
<table class="doxtable">
<tr>
<th>OpCode </th><th>Name </th><th>Description  </th></tr>
<tr>
<td>0 </td><td>Read </td><td>Select the configuration setting for reading. will load it from storage, then write it to the Config Read <a class="el" href="classCharacteristic.html" title="A default characteristic. ">Characteristic</a>. Length and payload of the configuration packet will be ignored </td></tr>
<tr>
<td>1 </td><td>Write </td><td>Write the state variable <b>disabled</b> </td></tr>
<tr>
<td>2 </td><td>Notify </td><td>Enable/Disable notifications for state variable. Every time the state variable is updated, the new value is written to the <a class="el" href="classState.html" title="Load StateVars from and save StateVars to persistent storage. ">State</a> Read <a class="el" href="classCharacteristic.html" title="A default characteristic. ">Characteristic</a>. To use effectively, enable GATT Notifications on the <a class="el" href="classState.html" title="Load StateVars from and save StateVars to persistent storage. ">State</a> Read <a class="el" href="classCharacteristic.html" title="A default characteristic. ">Characteristic</a>. Length has to be 1, and payload is 0 = disable, other = enable </td></tr>
</table>
<p>Note: On the <a class="el" href="classState.html" title="Load StateVars from and save StateVars to persistent storage. ">State</a> Read <a class="el" href="classCharacteristic.html" title="A default characteristic. ">Characteristic</a>, the OpCode is also set to distinguish between a one time read, and a continuous notification. In return, the length and payload will have actual data depending on the type.</p>
<h4><a class="anchor" id="state_error_bitmask"></a>Error Bitmask</h4>
<table class="doxtable">
<tr>
<th>Bit </th><th>Name </th><th>Description  </th></tr>
<tr>
<td>0 </td><td>Overcurrent </td><td>If this is 1, overcurrent was detected. </td></tr>
<tr>
<td>1 </td><td>Overcurrent dimmer </td><td>If this is 1, overcurrent for the dimmer was detected. </td></tr>
<tr>
<td>2 </td><td>Chip temperature </td><td>If this is 1, the chip temperature is too high. </td></tr>
<tr>
<td>3 </td><td>Dimmer temperature </td><td>If this is 1, the dimmer temperature is too high. </td></tr>
<tr>
<td>4-31 </td><td>Reserved </td><td>Reserved for future use. </td></tr>
</table>
<h3><a class="anchor" id="power_samples_packet"></a>Power samples packet</h3>
<div class="image">
<img src="../docs/diagrams/power-samples-packet.png"  alt="Power samples packet"/>
</div>
<table class="doxtable">
<tr>
<th>Type </th><th>Name </th><th>Length </th><th>Description  </th></tr>
<tr>
<td>uint 16 </td><td>numCurrentSamples </td><td>2 </td><td>Number of current samples. </td></tr>
<tr>
<td>uint 16 []</td><td>currentSamples </td><td>numCurrentSamples * 2 </td><td>Array of current samples. </td></tr>
<tr>
<td>uint 16 </td><td>numVoltageSamples </td><td>2 </td><td>Number of voltage samples. </td></tr>
<tr>
<td>uint 16 []</td><td>voltageSamples </td><td>numVoltageSamples * 2 </td><td>Array of voltage samples. </td></tr>
<tr>
<td>uint 16 </td><td>numCurrentTimeStamps </td><td>2 </td><td>Number of current timestamps. </td></tr>
<tr>
<td>uint 32 </td><td>firstCurrentTimeStamp </td><td>4 </td><td>Timestamp of first current sample. </td></tr>
<tr>
<td>uint 32 </td><td>lastCurrentTimeStamp </td><td>4 </td><td>Timestamp of last current sample. </td></tr>
<tr>
<td>int 8 [] </td><td>currentTimeDiffs </td><td>numCurrentTimeStamps-1 </td><td>Array of differences with previous timestamp. </td></tr>
<tr>
<td>uint 16 </td><td>numVoltageTimeStamps </td><td>2 </td><td>Number of voltage timestamps. </td></tr>
<tr>
<td>uint 32 </td><td>firstVoltageTimeStamp </td><td>4 </td><td>Timestamp of first voltage sample. </td></tr>
<tr>
<td>uint 32 </td><td>lastVoltageTimeStamp </td><td>4 </td><td>Timestamp of last voltage sample. </td></tr>
<tr>
<td>int 8 [] </td><td>voltageTimeDiffs </td><td>numVoltageTimeStamps-1 </td><td>Array of differences with previous timestamp. </td></tr>
</table>
<h3><a class="anchor" id="power_curve_packet"></a>Power curve packet, deprecated</h3>
<div class="image">
<img src="../docs/diagrams/power-curve-packet.png"  alt="Power curve packet"/>
</div>
<table class="doxtable">
<tr>
<th>Type </th><th>Name </th><th>Length </th><th>Description  </th></tr>
<tr>
<td>uint 16 </td><td>numSamples </td><td>2 </td><td>Number of current samples + voltage samples, including the first samples. </td></tr>
<tr>
<td>uint 16 </td><td>firstCurrent </td><td>2 </td><td>First current sample. </td></tr>
<tr>
<td>uint 16 </td><td>lastCurrent </td><td>2 </td><td>Last current sample. </td></tr>
<tr>
<td>uint 16 </td><td>firstVoltage </td><td>2 </td><td>First voltage sample. </td></tr>
<tr>
<td>uint 16 </td><td>lastVoltage </td><td>2 </td><td>Last voltage sample. </td></tr>
<tr>
<td>uint 32 </td><td>firstTimeStamp </td><td>4 </td><td>Timestamp of first current sample. </td></tr>
<tr>
<td>uint 32 </td><td>lastTimeStamp </td><td>4 </td><td>Timestamp of last sample. </td></tr>
<tr>
<td>int 8 []</td><td>currentDiffs </td><td>numSamples/2-1 </td><td>Array of differences with previous current sample. </td></tr>
<tr>
<td>int 8 []</td><td>voltageDiffs </td><td>numSamples/2-1 </td><td>Array of differences with previous voltage sample. </td></tr>
<tr>
<td>int 8 []</td><td>timeDiffs </td><td>numSamples-1 </td><td>Array of differences with previous timestamp. </td></tr>
</table>
<h3><a class="anchor" id="scan_result_packet"></a>Scan result packet</h3>
<table class="doxtable">
<tr>
<th>Type </th><th>Name </th><th>Length </th><th>Description  </th></tr>
<tr>
<td>uint 8 [] </td><td>Address </td><td>6 </td><td>Bluetooth address of the scanned device. </td></tr>
<tr>
<td>int 8 </td><td>RSSI </td><td>1 </td><td>Average RSSI to the scanned device. </td></tr>
<tr>
<td>uint 16 </td><td>Occurrences </td><td>2 </td><td>Number of times the devices was scanned. </td></tr>
</table>
<h3><a class="anchor" id="scan_result_list_packet"></a>Scan result list packet</h3>
<div class="image">
<img src="../docs/diagrams/scan-result-list-packet.png"  alt="Scan result list packet"/>
</div>
<table class="doxtable">
<tr>
<th>Type </th><th>Name </th><th>Length </th><th>Description  </th></tr>
<tr>
<td>uint 8 </td><td>size </td><td>1 </td><td>Number of scanned devices in the list. </td></tr>
</table>
<p><a href="#scan_result_packet">Scan result</a> | size * 9 | Array of scan result packets.</p>
<h3><a class="anchor" id="tracked_device_packet"></a>Tracked device packet</h3>
<div class="image">
<img src="../docs/diagrams/tracked-device-packet.png"  alt="Tracked device packet"/>
</div>
<table class="doxtable">
<tr>
<th>Type </th><th>Name </th><th>Length </th><th>Description  </th></tr>
<tr>
<td>uint 8 [] </td><td>Address </td><td>6 </td><td>Bluetooth address of the tracked device. </td></tr>
<tr>
<td>int 8 </td><td>RSSI threshold </td><td>1 </td><td>If the RSSI to this device is above the threshold, then switch on the power. </td></tr>
</table>
<h3><a class="anchor" id="tracked_device_list_packet"></a>Tracked device list packet</h3>
<div class="image">
<img src="../docs/diagrams/tracked-device-list-packet.png"  alt="Tracked device list packet"/>
</div>
<table class="doxtable">
<tr>
<th>Type </th><th>Name </th><th>Length </th><th>Description  </th></tr>
<tr>
<td>uint 8 </td><td>size </td><td>1 </td><td>Number of tracked devices in the list. </td></tr>
</table>
<p><a href="#tracked_device_packet">Tracked device</a> | size * 7 | Array of tracked device packets. uint 16 [] | Counters | size * 2 | Counter that keeps up how long ago the RSSI of a device was above the threshold (for internal use).</p>
<h3><a class="anchor" id="schedule_repeat_packet"></a>Schedule repeat packet</h3>
<h4>Repeat type 0</h4>
<p>Perform action every X minutes.</p>
<table class="doxtable">
<tr>
<th>Type </th><th>Name </th><th>Length </th><th>Description  </th></tr>
<tr>
<td>uint 16 </td><td>Repeat time </td><td>2 </td><td>Repeat every <code>&lt;repeat time&gt;</code> minutes, 0 is not allowed. </td></tr>
</table>
<h4>Repeat type 1</h4>
<p>Perform action every 24h, but only on certain days these days of the week.</p>
<table class="doxtable">
<tr>
<th>Type </th><th>Name </th><th>Length </th><th>Description  </th></tr>
<tr>
<td>uint 8 </td><td>Day of week </td><td>1 </td><td>Bitmask, with bits 0-6 for Sunday-Saturday and bit 7 for all days. </td></tr>
<tr>
<td>uint 8 </td><td>Next day of week </td><td>1 </td><td>Remember what day of week comes next. 0-6, where 0=Sunday. </td></tr>
</table>
<h4>Repeat type 2</h4>
<p>Perform action only once. Entry gets removed after action was performed.</p>
<table class="doxtable">
<tr>
<th>Type </th><th>Name </th><th>Length </th><th>Description  </th></tr>
<tr>
<td>uint 8 </td><td>Reserved </td><td>2 </td><td>Unused. </td></tr>
</table>
<h3><a class="anchor" id="schedule_action_packet"></a>Schedule action packet</h3>
<h4>Action type 0</h4>
<p>Set power switch to a given value.</p>
<table class="doxtable">
<tr>
<th>Type </th><th>Name </th><th>Length </th><th>Description  </th></tr>
<tr>
<td>uint 8 </td><td><a class="el" href="classSwitch.html">Switch</a> </td><td>1 </td><td>Power switch value. Range 0-100, where 0 is off and 100 is fully on. </td></tr>
<tr>
<td>uint 8 </td><td>Reserved </td><td>2 </td><td>Unused. </td></tr>
</table>
<h4>Action type 1</h4>
<p>Fade from current power switch value to a given power switch value, in X seconds. ** Not implemented yet. **</p>
<table class="doxtable">
<tr>
<th>Type </th><th>Name </th><th>Length </th><th>Description  </th></tr>
<tr>
<td>uint 8 </td><td><a class="el" href="classSwitch.html">Switch</a> end </td><td>1 </td><td>Power switch value after fading. </td></tr>
<tr>
<td>uint 16 </td><td>Fade duration </td><td>2 </td><td>Fade duration in seconds. </td></tr>
</table>
<h4>Action type 2</h4>
<p>Toggle the power switch.</p>
<table class="doxtable">
<tr>
<th>Type </th><th>Name </th><th>Length </th><th>Description  </th></tr>
<tr>
<td>uint 8 </td><td>Reserved </td><td>3 </td><td>Unused. </td></tr>
</table>
<h3><a class="anchor" id="schedule_entry_packet"></a>Schedule entry packet</h3>
<table class="doxtable">
<tr>
<th>Type </th><th>Name </th><th>Length </th><th>Description  </th></tr>
<tr>
<td>uint 8 </td><td>ID </td><td>1 </td><td>Unique id of this schedule entry. </td></tr>
<tr>
<td>uint 8 </td><td>Override mask </td><td>1 </td><td>Bitmask of states to override. Presence mask = 1. </td></tr>
<tr>
<td>uint 8 </td><td>Type </td><td>1 </td><td>Combined repeat and action type. Defined as <code>repeatType + (actionType &lt;&lt; 4)</code>. </td></tr>
<tr>
<td>uint 32 </td><td>Next timestamp </td><td>4 </td><td>Timestamp of the next time this entry triggers. Set to 0 to remove this entry. </td></tr>
<tr>
<td><a href="#schedule_repeat_packet">schedule repeat</a> </td><td>Repeat data </td><td>2 </td><td>Repeat time data, depends on the repeat type. </td></tr>
<tr>
<td><a href="#schedule_action_packet">schedule action</a> </td><td>Action data </td><td>3 </td><td>Action data, depends on the action type. </td></tr>
</table>
<h3><a class="anchor" id="schedule_list_packet"></a>Schedule list packet</h3>
<table class="doxtable">
<tr>
<th>Type </th><th>Name </th><th>Length </th><th>Description  </th></tr>
<tr>
<td>uint 8 </td><td>Size </td><td>1 </td><td>Number of entries in the list. </td></tr>
<tr>
<td><a href="#schedule_entry_packet">schedule entry</a> </td><td>Entries </td><td>12 </td><td>Schedule entry list. </td></tr>
</table>
<h3><a class="anchor" id="mesh_message_packet"></a><a class="el" href="classMesh.html" title="Wrapper class around the mesh protocol files. ">Mesh</a> message</h3>
<p>This packet is a slightly modified version of the one used in <a href="https://github.com/NordicSemiconductor/nRF51-ble-bcast-mesh">OpenMesh</a>; we simply increased the content size.</p>
<div class="image">
<img src="../docs/diagrams/openmesh-packet.png"  alt="Mesh packet"/>
</div>
<p>Type | Name | Length | Description &mdash; | &mdash; | &mdash; | &mdash; uint 8 | Preamble | 1 | uint 32 | Access address | 4 | Number used to find relevant messages, set by application. uint 8 | Type | 1 | uint 8 | Length | 1 | uint 8 [] | Source address | 6 | Address of the node that put this message into the mesh. uint 8 | AD Length | 1 | Length of data after this field, excluding CRC. uint 8 | AD type | 1 | uint 16 | <a class="el" href="classService.html" title="Service as defined in the GATT Specification. ">Service</a> <a class="el" href="classUUID.html" title="A Universally Unique IDentifier for BLE services and characteristics. ">UUID</a> | 2 | <a class="el" href="classMesh.html" title="Wrapper class around the mesh protocol files. ">Mesh</a> service <a class="el" href="classUUID.html" title="A Universally Unique IDentifier for BLE services and characteristics. ">UUID</a>. uint 16 | Handle | 2 | Handle of this message. uint 16 | Version | 2 | Used internally. <a href="#encrypted_mesh_packet">Encrypted mesh packet</a> | Payload | 104 | The encrypted mesh message. uint 8 [] | CRC | 3 | Checksum.</p>
<h3><a class="anchor" id="encrypted_mesh_packet"></a>Encrypted mesh packet</h3>
<p>This packet is sent over the mesh as payload in the mesh message.</p>
<div class="image">
<img src="../docs/diagrams/encrypted-mesh-packet.png"  alt="Encrypted mesh message"/>
</div>
<table class="doxtable">
<tr>
<th>Type </th><th>Name </th><th>Length </th><th>Description  </th></tr>
<tr>
<td>uint 32 </td><td>Message counter </td><td>4 </td><td>The message counter used to identify the message. Counter values are kept up seperately per handle. Note: This value is in plain text (unencrypted) </td></tr>
<tr>
<td>uint 32 </td><td>Random number </td><td>4 </td><td>The random number used for encryption/decryption, is sent itself unencrypted </td></tr>
<tr>
<td><a href="#mesh-packet">Mesh packet</a> </td><td>Encrypted payload </td><td>96 </td><td>The encrypted mesh packet. </td></tr>
</table>
<h3><a class="anchor" id="mesh-packet"></a><a class="el" href="classMesh.html" title="Wrapper class around the mesh protocol files. ">Mesh</a> packet</h3>
<p>This packet is encrypted and sent as payload in the encrypted mesh packet.</p>
<div class="image">
<img src="../docs/diagrams/mesh-packet.png"  alt="Mesh message"/>
</div>
<table class="doxtable">
<tr>
<th>Type </th><th>Name </th><th>Length </th><th>Description  </th></tr>
<tr>
<td>uint 32 </td><td>Message counter </td><td>4 </td><td>The message counter used to identify the message. Counter values are kept up seperately per handle. Note: This value will be compared after decryption to the message counter of the encrypted mesh message to make sure the message was not tampered with. </td></tr>
<tr>
<td><a href="#mesh_payload_packet">Mesh payload</a> </td><td>Payload </td><td>92 </td><td>Payload data </td></tr>
</table>
<h3><a class="anchor" id="mesh_control_packet"></a><a class="el" href="classMesh.html" title="Wrapper class around the mesh protocol files. ">Mesh</a> control packet</h3>
<p>This packet is sent to the <a href="#mesh_control_characteristic">Mesh control characteristic</a></p>
<div class="image">
<img src="../docs/diagrams/mesh-control-packet.png"  alt="Mesh control packet"/>
</div>
<table class="doxtable">
<tr>
<th>Type </th><th>Name </th><th>Length </th><th>Description  </th></tr>
<tr>
<td>uint 8 </td><td>Handle </td><td>1 </td><td>Handle on which to send the message. </td></tr>
<tr>
<td>uint 8 </td><td>Reserved </td><td>1 </td><td>Not used: reserved for alignment. </td></tr>
<tr>
<td>uint 16 </td><td>Length </td><td>2 </td><td>Length of the data. </td></tr>
<tr>
<td><a href="#mesh_payload_packet">Mesh payload</a> </td><td>Payload </td><td>0 - 92 </td><td>Payload data, max 92 bytes, but actual length is determined by the handle </td></tr>
</table>
<h3><a class="anchor" id="mesh_payload_packet"></a><a class="el" href="classMesh.html" title="Wrapper class around the mesh protocol files. ">Mesh</a> payload packet</h3>
<p>The mesh payload packet is defined by the handle. We have the following handles</p>
<table class="doxtable">
<tr>
<th>Handle </th><th>Name </th><th>Type </th><th>Description  </th></tr>
<tr>
<td>1 </td><td>Keep alive channel </td><td><a href="#keep_alive_mesh_packet">Keep alive</a> </td><td>Channel on which the keep alive messages are sent. A message consists of a global timeout and a number of keep alive items (on per stone which is addressed). If the length of the mesh control packet is 0, the existing keepalive message will be repeated. </td></tr>
<tr>
<td>2 </td><td><a class="el" href="classState.html" title="Load StateVars from and save StateVars to persistent storage. ">State</a> broadcast channel </td><td><a href="#state_mesh_packet">State</a> </td><td>Each stone sends it's state periodically over the mesh. The message is designed as a circular buffer and a new item is added at the end (throwing out the oldest if full) </td></tr>
<tr>
<td>3 </td><td><a class="el" href="classState.html" title="Load StateVars from and save StateVars to persistent storage. ">State</a> change channel </td><td><a href="#state_mesh_packet">State</a> </td><td>Each stone sends its' state on this channel if the state changes significantly, e.g. switch state changes. </td></tr>
<tr>
<td>4 </td><td>Command channel </td><td><a href="#command_mesh_packet">Command</a> </td><td>Commands can be sent to one, multiple or all stones sharing the mesh network. Once a stone receives a command it will send a reply on the reply channel </td></tr>
<tr>
<td>5 </td><td>Command reply channel </td><td><a href="#command_reply_packet">Command reply</a> </td><td>Every stone that was targeted with a command adds its reply to the reply message. </td></tr>
<tr>
<td>6 </td><td>Scan result channel </td><td><a href="#scan_result_mesh_packet">Scan result</a> </td><td>If a stone is scanning for devices it adds its scanned devices periodically to this list to be sent over the mesh </td></tr>
<tr>
<td>7 </td><td>Big data channel </td><td>- </td><td>This channel is for the case when a stone needs to send big data, such as the history of eneregy usage, etc. </td></tr>
<tr>
<td>8 </td><td>Multi switch channel </td><td><a href="#multi_switch_mesh_packet">Multi switch</a> </td><td>This channel is used to send different switch commands with individual timeouts, switch states and intents to different crownstones in one message </td></tr>
</table>
<h4><a class="anchor" id="keep_alive_mesh_packet"></a>Keep alive packet</h4>
<div class="image">
<img src="../docs/diagrams/keep-alive-mesh-packet.png"  alt="Keep Alive packet"/>
</div>
<p>Deprecated: If the length of the mesh control packet is 0, the existing keepalive message will be repeated. This is used to delay the existing time outs by people who do not have permission to change the state.</p>
<table class="doxtable">
<tr>
<th>Type </th><th>Name </th><th>Length </th><th>Description  </th></tr>
<tr>
<td>uint 16 </td><td>Timeout </td><td>2 </td><td>Timeout (in seconds), applies to all stones present in the list. </td></tr>
<tr>
<td>uint 8 </td><td>Size </td><td>1 </td><td>Number of keep alive items in the list. </td></tr>
<tr>
<td>uint 8 [2] </td><td>Reserved </td><td>2 </td><td>Reserved for future use. </td></tr>
<tr>
<td><a href="#keep_alive_mesh_item">Keep alive item</a> [] </td><td>List </td><td>N </td><td>The keep alive items. </td></tr>
</table>
<h5><a class="anchor" id="keep_alive_mesh_item"></a>Keep alive Item</h5>
<table class="doxtable">
<tr>
<th>Type </th><th>Name </th><th>Length </th><th>Description  </th></tr>
<tr>
<td>uint 16 </td><td><a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a> ID </td><td>2 </td><td>The identifier of the crownstone to which this keep alive item is targeted </td></tr>
<tr>
<td><a href="#action_switch_state_keep_alive">Action + switch state</a> </td><td>Action + switch state </td><td>1 </td><td>A combined element for action and switch state, which should be executed by the targeted crownstone when the keep alive times out </td></tr>
</table>
<h5><a class="anchor" id="action_switch_state_keep_alive"></a>Action + switch state</h5>
<table class="doxtable">
<tr>
<th>Value </th><th>Name  </th></tr>
<tr>
<td>255 </td><td>No action </td></tr>
<tr>
<td>... </td><td>... </td></tr>
<tr>
<td>0-100 </td><td><a class="el" href="classSwitch.html">Switch</a> power: 0 = off, 100 = on, dimmed in between. </td></tr>
</table>
<h4><a class="anchor" id="state_mesh_packet"></a><a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a> state packet</h4>
<div class="image">
<img src="../docs/diagrams/state-mesh-packet.png"  alt="Crownstone State packet"/>
</div>
<table class="doxtable">
<tr>
<th>Type </th><th>Name </th><th>Length </th><th>Description  </th></tr>
<tr>
<td>uint 8 </td><td>Head </td><td>1 </td><td>Keeps the index of the oldest element in the list (read pointer) </td></tr>
<tr>
<td>uint 8 </td><td>Tail </td><td>1 </td><td>Keeps the index where the next element can be inserted in the list (write pointer) </td></tr>
<tr>
<td>uint 8 </td><td>Size </td><td>1 </td><td>Number of elements in the list </td></tr>
<tr>
<td>uint 8 </td><td>Reserved </td><td>1 </td><td>Reserved for future use </td></tr>
<tr>
<td>uint 32 </td><td>Timestamp </td><td>4 </td><td>Posix timestamp at which this message was originally sent (0 for unknown time) </td></tr>
<tr>
<td><a href="#state_mesh_item">Crownstone state item</a> [] </td><td>List </td><td>7 </td><td>Circular list with <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a> state items </td></tr>
</table>
<h5><a class="anchor" id="state_mesh_item"></a><a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a> state item</h5>
<table class="doxtable">
<tr>
<th>Type </th><th>Name </th><th>Length </th><th>Description  </th></tr>
<tr>
<td>uint 16 </td><td><a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a> ID </td><td>2 </td><td>The identifier of the crownstone which has this state </td></tr>
<tr>
<td>uint 8 </td><td><a class="el" href="classSwitch.html">Switch</a> state </td><td>1 </td><td>The current <a href="#switch_state_packet">Switch state</a> of the crownstone </td></tr>
<tr>
<td>uint 8 </td><td>Event bitmask </td><td>1 </td><td>The current <a href="#event_bitmask">Event bitmask</a> of the crownstone </td></tr>
<tr>
<td>int 32 </td><td>Power usage </td><td>4 </td><td>The current power usage of the crownstone (mW) </td></tr>
<tr>
<td>int 32 </td><td>Accumulated energy </td><td>4 </td><td>The accumulated energy since setup (Wh) </td></tr>
</table>
<h4><a class="anchor" id="command_mesh_packet"></a>Command packet</h4>
<div class="image">
<img src="../docs/diagrams/command-mesh-packet.png"  alt="Command packet"/>
</div>
<table class="doxtable">
<tr>
<th>Type </th><th>Name </th><th>Length </th><th>Description  </th></tr>
<tr>
<td>uint 16 </td><td><a href="#mesh_command_types">Command type</a> </td><td>2 </td><td>Type of command, see table below. </td></tr>
<tr>
<td>uint 8 </td><td>Number of IDs </td><td>1 </td><td>The number of IDs provided as targets, 0 for broadcast </td></tr>
<tr>
<td>uint16 [] </td><td>List of target IDs </td><td>Number of IDs </td><td><a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a> Identifiers of the devices at which this message is aimed, for broadcast, no IDs are provided and the command follows directly after the Number of IDs element </td></tr>
<tr>
<td>uint 8 </td><td>Command payload </td><td>N </td><td>The command payload data, which depends on the message type </td></tr>
</table>
<h5><a class="anchor" id="mesh_command_types"></a>Command types</h5>
<table class="doxtable">
<tr>
<th>Type nr </th><th>Type name </th><th>Payload type </th><th>Payload description  </th></tr>
<tr>
<td>0 </td><td>Control </td><td><a href="#control_packet">Control</a> </td><td>Send a control command over the mesh, see control packet </td></tr>
<tr>
<td>1 </td><td>Beacon </td><td><a href="#beacon_mesh_data_packet">Beacon Config</a> </td><td>Configure the iBeacon settings. </td></tr>
<tr>
<td>2 </td><td>Config </td><td><a href="#config_packet">Configuration</a> </td><td>Send/Request a configuration setting, see configuration packet </td></tr>
<tr>
<td>3 </td><td><a class="el" href="classState.html" title="Load StateVars from and save StateVars to persistent storage. ">State</a> </td><td><a href="#state_packet">State</a> </td><td>Send/Request a state variable, see state packet </td></tr>
</table>
<h5><a class="anchor" id="beacon_mesh_data_packet"></a>Beacon config packet</h5>
<div class="image">
<img src="../docs/diagrams/beacon-config-command-packet.png"  alt="Beacon data"/>
</div>
<table class="doxtable">
<tr>
<th>Type </th><th>Name </th><th>Length </th><th>Description  </th></tr>
<tr>
<td>uint 16 </td><td>Major </td><td>2 </td><td>iBeacon major number </td></tr>
<tr>
<td>uint 16 </td><td>Minor </td><td>2 </td><td>iBeacon minor number </td></tr>
<tr>
<td>uint 8 </td><td>Proximity <a class="el" href="classUUID.html" title="A Universally Unique IDentifier for BLE services and characteristics. ">UUID</a> </td><td>16 </td><td>iBeacon <a class="el" href="classUUID.html" title="A Universally Unique IDentifier for BLE services and characteristics. ">UUID</a> </td></tr>
<tr>
<td>int 8 </td><td>TX power </td><td>1 </td><td>iBeacon signal strength at 1 meter. </td></tr>
</table>
<h4><a class="anchor" id="command_reply_mesh_packet"></a>Command reply packet</h4>
<div class="image">
<img src="../docs/diagrams/command-reply-mesh-packet.png"  alt="Command Reply packet"/>
</div>
<table class="doxtable">
<tr>
<th>Type </th><th>Name </th><th>Length </th><th>Description  </th></tr>
<tr>
<td>uint 16 </td><td><a href="#mesh_reply_types">Reply type</a> </td><td>2 </td><td>Type of reply, see table below </td></tr>
<tr>
<td>uint 32 </td><td>Message counter </td><td>4 </td><td>The message number of the command to which this reply belongs </td></tr>
<tr>
<td>uint 8 </td><td>Number of replies </td><td>1 </td><td>Number of reply items in the list </td></tr>
<tr>
<td>uint 8 </td><td>List of replies </td><td>85 </td><td>List of replies, the format is defined by the type of reply </td></tr>
</table>
<h5><a class="anchor" id="mesh_reply_types"></a>Reply types</h5>
<table class="doxtable">
<tr>
<th>Type nr </th><th>Type name </th><th>Payload type </th><th>Payload description  </th></tr>
<tr>
<td>0 </td><td><a class="el" href="structStatus.html" title="Status of a Characteristic. ">Status</a> reply </td><td><a href="#mesh_status_reply">Status reply item</a> </td><td>Send a status code back, used to report errors. And to report success for control and config write commands. </td></tr>
<tr>
<td>1 </td><td>Config reply </td><td><a href="#mesh_config_reply">Config reply item</a> </td><td>Return the requested config. </td></tr>
<tr>
<td>2 </td><td><a class="el" href="classState.html" title="Load StateVars from and save StateVars to persistent storage. ">State</a> reply </td><td><a href="#mesh_state_reply">State reply item</a> </td><td>Return the requested state variable. </td></tr>
</table>
<h6><a class="anchor" id="mesh_status_reply"></a><a class="el" href="structStatus.html" title="Status of a Characteristic. ">Status</a> reply item</h6>
<div class="image">
<img src="../docs/diagrams/mesh-status-reply-item.png"  alt="Status reply item"/>
</div>
<table class="doxtable">
<tr>
<th>Type </th><th>Name </th><th>Length </th><th>Description  </th></tr>
<tr>
<td>uint 16 </td><td><a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a> ID </td><td>2 </td><td>The identifier of the crownstone which sent the status reply </td></tr>
<tr>
<td>uint 16 </td><td><a class="el" href="structStatus.html" title="Status of a Characteristic. ">Status</a> </td><td>2 </td><td>The status code of the reply, see <a href="#return_values">Return Values</a> </td></tr>
</table>
<h6><a class="anchor" id="mesh_config_reply"></a>Config reply item</h6>
<div class="image">
<img src="../docs/diagrams/mesh-config-reply-item.png"  alt="Config reply item"/>
</div>
<table class="doxtable">
<tr>
<th>Type </th><th>Name </th><th>Length </th><th>Description  </th></tr>
<tr>
<td>uint 16 </td><td><a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a> ID </td><td>2 </td><td>The identifier of the crownstone which sent the status reply </td></tr>
<tr>
<td>uint 8 </td><td>Type </td><td>1 </td><td>see <a href="#config_packet">Configuration Packet</a> </td></tr>
<tr>
<td>uint 8 </td><td>OpCode </td><td>1 </td><td>see <a href="#config_packet">Configuration Packet</a> </td></tr>
<tr>
<td>uint 16 </td><td>Length </td><td>2 </td><td>see <a href="#config_packet">Configuration Packet</a> </td></tr>
<tr>
<td>uint 8 </td><td>Payload </td><td>Length </td><td>see <a href="#config_packet">Configuration Packet</a> </td></tr>
</table>
<h6><a class="anchor" id="mesh_state_reply"></a><a class="el" href="classState.html" title="Load StateVars from and save StateVars to persistent storage. ">State</a> reply item</h6>
<div class="image">
<img src="../docs/diagrams/mesh-state-reply-item.png"  alt="State Reply packet"/>
</div>
<table class="doxtable">
<tr>
<th>Type </th><th>Name </th><th>Length </th><th>Description  </th></tr>
<tr>
<td>uint 16 </td><td><a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a> ID </td><td>2 </td><td>The identifier of the crownstone which sent the status reply </td></tr>
<tr>
<td>uint 8 </td><td>Type </td><td>1 </td><td>see <a href="#state_packet">State Packet</a> </td></tr>
<tr>
<td>uint 8 </td><td>OpCode </td><td>1 </td><td>see <a href="#state_packet">State Packet</a> </td></tr>
<tr>
<td>uint 16 </td><td>Length </td><td>2 </td><td>see <a href="#state_packet">State Packet</a> </td></tr>
<tr>
<td>uint 8 </td><td>Payload </td><td>Length </td><td>see <a href="#state_packet">State Packet</a> </td></tr>
</table>
<h4><a class="anchor" id="scan_result_mesh_packet"></a>Scan result packet</h4>
<div class="image">
<img src="../docs/diagrams/scan-result-mesh-packet.png"  alt="Scan Result packet"/>
</div>
<table class="doxtable">
<tr>
<th>Type </th><th>Name </th><th>Length </th><th>Description  </th></tr>
<tr>
<td>uint 8 </td><td>Number of results </td><td>1 </td><td>Number of scan results in the list </td></tr>
<tr>
<td>uint 8 </td><td>Reserved </td><td>1 </td><td>Reserved for future use </td></tr>
<tr>
<td><a href="#scan_result_item">Scan Result item</a> [] </td><td>List </td><td>Number of results </td><td>A list of scanned devices with the ID of the crownstone that scanned the device </td></tr>
</table>
<h5><a class="anchor" id="mesh_scan_result_item"></a>Scan result item</h5>
<table class="doxtable">
<tr>
<th>Type </th><th>Name </th><th>Length </th><th>Description  </th></tr>
<tr>
<td>uint 16 </td><td><a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a> ID </td><td>2 </td><td>The identifier of the <a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a> which scanned the device </td></tr>
<tr>
<td>uint 8 [6] </td><td>Scanned device address </td><td>6 </td><td>The MAC address of the scanned device </td></tr>
<tr>
<td>int 8 </td><td>RSSI </td><td>1 </td><td>The averaged RSSI value of the scanned device </td></tr>
</table>
<h5><a class="anchor" id="multi_switch_mesh_packet"></a>Multi switch packet</h5>
<div class="image">
<img src="../docs/diagrams/multi-switch-mesh-packet.png"  alt="Keep Alive packet"/>
</div>
<table class="doxtable">
<tr>
<th>Type </th><th>Name </th><th>Length </th><th>Description  </th></tr>
<tr>
<td>uint 8 </td><td>Size </td><td>1 </td><td>Number of keep alive items in the list </td></tr>
<tr>
<td>uint 8 </td><td>Reserved </td><td>1 </td><td>Reserved for future use </td></tr>
<tr>
<td><a href="#multi_switch_mesh_item">Multi switch item</a> [] </td><td>List </td><td>N </td><td>a list of targeted crownstones with switch states, timeouts and intents </td></tr>
</table>
<h5><a class="anchor" id="multi_switch_mesh_item"></a>Multi switch item</h5>
<table class="doxtable">
<tr>
<th>Type </th><th>Name </th><th>Length </th><th>Description  </th></tr>
<tr>
<td>uint 16 </td><td><a class="el" href="classCrownstone.html" title="Crownstone encapsulates all functionality, stack, services, and configuration. ">Crownstone</a> ID </td><td>2 </td><td>The identifier of the crownstone to which this item is targeted </td></tr>
<tr>
<td>uint 8 </td><td><a class="el" href="classSwitch.html">Switch</a> state </td><td>1 </td><td>The switch state to be set by the targeted crownstone after the timeout expires. 0 = off, 100 = fully on. </td></tr>
<tr>
<td>uint 16 </td><td>Timeout </td><td>2 </td><td>The timeout (in seconds) after which the state should be set </td></tr>
<tr>
<td>uint 8 </td><td><a href="#multi_switch_intent">Intent</a> </td><td>1 </td><td>The intent of the switch, see the table below </td></tr>
</table>
<h6><a class="anchor" id="multi_switch_intent"></a>Intent</h6>
<table class="doxtable">
<tr>
<th>Value </th><th>Name  </th></tr>
<tr>
<td>0 </td><td>Sphere Enter </td></tr>
<tr>
<td>1 </td><td>Sphere Exit </td></tr>
<tr>
<td>2 </td><td>Enter </td></tr>
<tr>
<td>3 </td><td>Exit </td></tr>
<tr>
<td>4 </td><td>Manual </td></tr>
</table>
<h3><a class="anchor" id="mesh_notification_packet"></a><a class="el" href="classMesh.html" title="Wrapper class around the mesh protocol files. ">Mesh</a> notification packet</h3>
<p>This packet is used to get the <a href="#mesh_message_packet">mesh messages</a> pushed over GATT notifications.</p>
<div class="image">
<img src="../docs/diagrams/mesh-notification-packet.png"  alt="Mesh notification packet"/>
</div>
<table class="doxtable">
<tr>
<th>Type </th><th>Name </th><th>Length </th><th>Description  </th></tr>
<tr>
<td>uint 8 </td><td>OpCode </td><td>1 </td><td>See available op codes in table below </td></tr>
</table>
<p>uint 8 | Payload | |</p>
<table class="doxtable">
<tr>
<th>Opcode </th><th>Type name </th><th>Payload type </th><th>Payload Description  </th></tr>
<tr>
<td>0 </td><td>Data </td><td><a href="#mesh_data_update_packet">Mesh data update</a> </td><td>Single part notification (if all data fits in one packet). </td></tr>
<tr>
<td>1 </td><td>Flag Set </td><td></td><td>Not used. </td></tr>
<tr>
<td>2 </td><td>Flag Req </td><td></td><td>Not used. </td></tr>
<tr>
<td>17 </td><td>Cmd Rsp </td><td></td><td>Not used. </td></tr>
<tr>
<td>18 </td><td>Flag Rsp </td><td></td><td>Not used. </td></tr>
<tr>
<td>32 </td><td>MultipartStart </td><td><a href="#mesh_data_update_packet">Mesh data update</a> </td><td>First part of the multi part notification. </td></tr>
<tr>
<td>33 </td><td>MultipartMid </td><td><a href="#mesh_data_update_packet">Mesh data update</a> </td><td>Middle part of the multi part notification. </td></tr>
<tr>
<td>34 </td><td>MultipartEnd </td><td><a href="#mesh_data_update_packet">Mesh data update</a> </td><td>Last part of the multi part notification. </td></tr>
</table>
<h3><a class="anchor" id="mesh_data_update_packet"></a><a class="el" href="classMesh.html" title="Wrapper class around the mesh protocol files. ">Mesh</a> data update packet</h3>
<p>Each mesh data message is notified in multiple pieces, as a notification can only be 20 bytes. The op code of the <a href="#mesh_notification_packet">Mesh notification</a> tells whether it is a single, or the first, last or a middle piece of a multipart message.</p>
<div class="image">
<img src="../docs/diagrams/mesh-data-update-packet.png"  alt="Mesh data notification packet"/>
</div>
<table class="doxtable">
<tr>
<th>Type </th><th>Name </th><th>Length </th><th>Description  </th></tr>
<tr>
<td>uint 16 </td><td>Handle </td><td>2 </td><td>Handle on which the messages was sent or received. </td></tr>
<tr>
<td>uint 8 </td><td>Length </td><td>1 </td><td>Length of the data of this part. </td></tr>
<tr>
<td>uint 8 </td><td>Data </td><td>Length </td><td>Data of this part. If OpCode is Data, it is the length of the whole mesh message, otherwise it is the length of the current part. </td></tr>
</table>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
