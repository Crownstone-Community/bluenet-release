<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>Bluenet: ADC Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Bluenet
   &#160;<span id="projectnumber">0.3.0</span>
   </div>
   <div id="projectbrief">Bluenet, the firmware for the Crownstone power outlet</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="annotated.html"><span>Class&#160;List</span></a></li>
      <li><a href="classes.html"><span>Class&#160;Index</span></a></li>
      <li><a href="inherits.html"><span>Class&#160;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&#160;Members</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="#pub-static-methods">Static Public Member Functions</a> &#124;
<a href="#pro-static-methods">Static Protected Member Functions</a> &#124;
<a href="classADC-members.html">List of all members</a>  </div>
  <div class="headertitle">
<div class="title">ADC Class Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Analog-Digital conversion.  
 <a href="classADC.html#details">More...</a></p>

<p><code>#include &lt;<a class="el" href="cs__ADC_8h_source.html">cs_ADC.h</a>&gt;</code></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr class="memitem:a4133d681d97cd1a9bb07c7c9652edc9c"><td class="memItemLeft" align="right" valign="top">cs_adc_error_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classADC.html#a4133d681d97cd1a9bb07c7c9652edc9c">init</a> (const pin_id_t pins[], const pin_count_t numPins)</td></tr>
<tr class="memdesc:a4133d681d97cd1a9bb07c7c9652edc9c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize <a class="el" href="classADC.html" title="Analog-Digital conversion. ">ADC</a>.  <a href="#a4133d681d97cd1a9bb07c7c9652edc9c">More...</a><br/></td></tr>
<tr class="separator:a4133d681d97cd1a9bb07c7c9652edc9c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a77afa039c73f7e50d04fe64e8e79d412"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a77afa039c73f7e50d04fe64e8e79d412"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classADC.html#a77afa039c73f7e50d04fe64e8e79d412">start</a> ()</td></tr>
<tr class="memdesc:a77afa039c73f7e50d04fe64e8e79d412"><td class="mdescLeft">&#160;</td><td class="mdescRight">Start the <a class="el" href="classADC.html" title="Analog-Digital conversion. ">ADC</a> sampling. <br/></td></tr>
<tr class="separator:a77afa039c73f7e50d04fe64e8e79d412"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af92b34ed7a2ed66b1da7858a58faf140"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="af92b34ed7a2ed66b1da7858a58faf140"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classADC.html#af92b34ed7a2ed66b1da7858a58faf140">stop</a> ()</td></tr>
<tr class="memdesc:af92b34ed7a2ed66b1da7858a58faf140"><td class="mdescLeft">&#160;</td><td class="mdescRight">Stop the <a class="el" href="classADC.html" title="Analog-Digital conversion. ">ADC</a> sampling. <br/></td></tr>
<tr class="separator:af92b34ed7a2ed66b1da7858a58faf140"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad4fef81b54aa4407903c5edb7b74da8d"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classADC.html#ad4fef81b54aa4407903c5edb7b74da8d">releaseBuffer</a> (nrf_saadc_value_t *buf)</td></tr>
<tr class="memdesc:ad4fef81b54aa4407903c5edb7b74da8d"><td class="mdescLeft">&#160;</td><td class="mdescRight">Release a buffer, so it can be used again by the <a class="el" href="classADC.html" title="Analog-Digital conversion. ">ADC</a>.  <a href="#ad4fef81b54aa4407903c5edb7b74da8d">More...</a><br/></td></tr>
<tr class="separator:ad4fef81b54aa4407903c5edb7b74da8d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7f2a9a7bd30cc52ae89857573ebd8be0"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classADC.html#a7f2a9a7bd30cc52ae89857573ebd8be0">setDoneCallback</a> (adc_done_cb_t callback)</td></tr>
<tr class="memdesc:a7f2a9a7bd30cc52ae89857573ebd8be0"><td class="mdescLeft">&#160;</td><td class="mdescRight">Set the callback which is called when a buffer is filled.  <a href="#a7f2a9a7bd30cc52ae89857573ebd8be0">More...</a><br/></td></tr>
<tr class="separator:a7f2a9a7bd30cc52ae89857573ebd8be0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad6a5d07f41d656e760ea4fd55834574c"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classADC.html#ad6a5d07f41d656e760ea4fd55834574c">update</a> (nrf_saadc_value_t *buf)</td></tr>
<tr class="memdesc:ad6a5d07f41d656e760ea4fd55834574c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Update this object with a buffer with values from the <a class="el" href="classADC.html" title="Analog-Digital conversion. ">ADC</a> conversion.  <a href="#ad6a5d07f41d656e760ea4fd55834574c">More...</a><br/></td></tr>
<tr class="separator:ad6a5d07f41d656e760ea4fd55834574c"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-static-methods"></a>
Static Public Member Functions</h2></td></tr>
<tr class="memitem:a314f14380849b63758a4f919d2a3321f"><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a314f14380849b63758a4f919d2a3321f"></a>
static <a class="el" href="classADC.html">ADC</a> &amp;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classADC.html#a314f14380849b63758a4f919d2a3321f">getInstance</a> ()</td></tr>
<tr class="memdesc:a314f14380849b63758a4f919d2a3321f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Use static variant of singleton, no dynamic memory allocation. <br/></td></tr>
<tr class="separator:a314f14380849b63758a4f919d2a3321f"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pro-static-methods"></a>
Static Protected Member Functions</h2></td></tr>
<tr class="memitem:a501d9c5cb17fbcc304d47d9677ef0383"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classADC.html#a501d9c5cb17fbcc304d47d9677ef0383">staticTimerHandler</a> (nrf_timer_event_t event_type, void *ptr)</td></tr>
<tr class="memdesc:a501d9c5cb17fbcc304d47d9677ef0383"><td class="mdescLeft">&#160;</td><td class="mdescRight">Callback for when the internal timer is started.  <a href="#a501d9c5cb17fbcc304d47d9677ef0383">More...</a><br/></td></tr>
<tr class="separator:a501d9c5cb17fbcc304d47d9677ef0383"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Analog-Digital conversion. </p>
<p>The <a class="el" href="classADC.html" title="Analog-Digital conversion. ">ADC</a> is a hardware peripheral that can be initialized for a particular pin. Subsequently, the analog signal is converted into a digital value. The resolution of the conversion is limited (default 10 bits). The conversion is used to get the current curve.</p>
<p>There is only one <a class="el" href="classADC.html" title="Analog-Digital conversion. ">ADC</a> hardware peripheral, hence this class conforms to the singleton design pattern.</p>
<p>The constructor does NOT have arguments you might expect, such as the number of buffers to use, or the size of the buffers. These are all set through preprocessor macros. The <a class="el" href="classADC.html" title="Analog-Digital conversion. ">ADC</a> class requires access to the following macros (see below).</p>
<p>The timer used to get new samples on regular time intervals. The timer should be able to run on at least 2kHz to be able to get the fine-grained current and voltage data we want.</p>
<ul>
<li>CS_ADC_TIMER The timer peripheral to use for the <a class="el" href="classADC.html" title="Analog-Digital conversion. ">ADC</a> peripheral.</li>
<li>CS_ADC_INSTANCE_INDEX The instance id of the timer. TODO: What is this?</li>
<li>CS_ADC_TIMER_ID TODO: What is this?</li>
</ul>
<p>The buffers to be used internally. To have these buffers in the form of macros means that we can check at compile time if they are small enough with respect to the nRF52 memory limitations.</p>
<ul>
<li>CS_ADC_NUM_BUFFERS The number of <a class="el" href="classADC.html" title="Analog-Digital conversion. ">ADC</a> buffers to use.</li>
<li>CS_ADC_BUF_SIZE The size of the buffer (first time used in <a class="el" href="classADC.html#a4133d681d97cd1a9bb07c7c9652edc9c" title="Initialize ADC. ">init()</a>).</li>
</ul>
<p>The pins:</p>
<ul>
<li>CS_ADC_MAX_PINS The maximum number of pins available for <a class="el" href="classADC.html" title="Analog-Digital conversion. ">ADC</a>.</li>
</ul>
<p>The sequence of events is as follows:</p>
<ol type="1">
<li>The C interrupt service routine, saadc_callback(nrf_drv_saadc_evt_t const * p_event) can be found in the corresponding implementation file. This function uses the singleton feature to call update on an event from the <a class="el" href="classADC.html" title="Analog-Digital conversion. ">ADC</a> peripheral, in particular, NRF_DRV_SAADC_EVT_DONE, with a buffer as argument.</li>
<li>The <a class="el" href="classADC.html#ad6a5d07f41d656e760ea4fd55834574c" title="Update this object with a buffer with values from the ADC conversion. ">update()</a> routine puts an internal C function, adc_done, with _doneCallback as argument in the event queue of the scheduler. This calls the callback function set previously in <a class="el" href="classADC.html#a7f2a9a7bd30cc52ae89857573ebd8be0" title="Set the callback which is called when a buffer is filled. ">setDoneCallback()</a> by a particular caller, e.g. the cs_PowerSampling. In this particular case it ends up in <a class="el" href="classPowerSampling.html#ad0eab4314d0b6f14333b8982bc317194" title="Called when the sample burst is finished. ">PowerSampling::powerSampleAdcDone</a> that after processing the data calls releaseBuffer(bufNum).</li>
<li>The releaseBuffer function clears the _doneCallbackData structure and queues a new buffer. Note that all processing has taken place by now.</li>
</ol>
<p>Note. In the <a class="el" href="classADC.html" title="Analog-Digital conversion. ">ADC</a> it is assumed that the member object is not updated (_doneCallbackData.bufName == bufNum) in the mean while. In other words, it should not be possible to get a second interrupt before releaseBuffer has been called. Scheduling a new <a class="el" href="classADC.html" title="Analog-Digital conversion. ">ADC</a> task is only done at the end of the releaseBuffer function. </p>
</div><h2 class="groupheader">Member Function Documentation</h2>
<a class="anchor" id="a4133d681d97cd1a9bb07c7c9652edc9c"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">cs_adc_error_t ADC::init </td>
          <td>(</td>
          <td class="paramtype">const pin_id_t&#160;</td>
          <td class="paramname"><em>pins</em>[], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const pin_count_t&#160;</td>
          <td class="paramname"><em>numPins</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Initialize <a class="el" href="classADC.html" title="Analog-Digital conversion. ">ADC</a>. </p>
<p>The init function must called once before operating the AD converter. Call it after you start the SoftDevice.</p>
<p>TODO: Not all pins can be used for <a class="el" href="classADC.html" title="Analog-Digital conversion. ">ADC</a> conversion. Check if the proper pins are assessed. TODO: Send array by reference, waste of stack.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">pins</td><td>Array of pins to use as input (AIN&lt;pin&gt;). <a class="el" href="classADC.html" title="Analog-Digital conversion. ">ADC</a> will alternate between these pins. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">size</td><td>Size of the array. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Error code (0 means success). </dd></dl>

</div>
</div>
<a class="anchor" id="ad4fef81b54aa4407903c5edb7b74da8d"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool ADC::releaseBuffer </td>
          <td>(</td>
          <td class="paramtype">nrf_saadc_value_t *&#160;</td>
          <td class="paramname"><em>buf</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Release a buffer, so it can be used again by the <a class="el" href="classADC.html" title="Analog-Digital conversion. ">ADC</a>. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">buf</td><td>Pointer to the buffer, as received in the done callback. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Boolean indicating success (true) or failure (false). </dd></dl>

</div>
</div>
<a class="anchor" id="a7f2a9a7bd30cc52ae89857573ebd8be0"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ADC::setDoneCallback </td>
          <td>(</td>
          <td class="paramtype">adc_done_cb_t&#160;</td>
          <td class="paramname"><em>callback</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Set the callback which is called when a buffer is filled. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">callback</td><td>Function to be called on an <a class="el" href="classADC.html" title="Analog-Digital conversion. ">ADC</a> event (any event)! </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a class="anchor" id="a501d9c5cb17fbcc304d47d9677ef0383"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void ADC::staticTimerHandler </td>
          <td>(</td>
          <td class="paramtype">nrf_timer_event_t&#160;</td>
          <td class="paramname"><em>event_type</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>ptr</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span><span class="mlabel">protected</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Callback for when the internal timer is started. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">event_type</td><td>The <a class="el" href="classADC.html" title="Analog-Digital conversion. ">ADC</a> is coupled to a timer which emits events. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ptr</td><td>: What's this? </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a class="anchor" id="ad6a5d07f41d656e760ea4fd55834574c"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ADC::update </td>
          <td>(</td>
          <td class="paramtype">nrf_saadc_value_t *&#160;</td>
          <td class="paramname"><em>buf</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Update this object with a buffer with values from the <a class="el" href="classADC.html" title="Analog-Digital conversion. ">ADC</a> conversion. </p>
<p>This <a class="el" href="classADC.html#ad6a5d07f41d656e760ea4fd55834574c" title="Update this object with a buffer with values from the ADC conversion. ">update()</a> function is also called from the <a class="el" href="classADC.html" title="Analog-Digital conversion. ">ADC</a> interrupt service routine. In this case an entire buffer has been made available. This is done by having the <a class="el" href="classADC.html" title="Analog-Digital conversion. ">ADC</a> peripheral directly writing into a part of the FLASH using the Easy-DMA peripheral and inter-peripheral communication (called PPI). Note that this function is time-sensitive. The number of activities in it are limited to a minimal number. The values are only copied and not processed further.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">buf</td><td>A buffer with size defined in the constructor. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<hr/>The documentation for this class was generated from the following file:<ul>
<li>include/drivers/<a class="el" href="cs__ADC_8h_source.html">cs_ADC.h</a></li>
</ul>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
